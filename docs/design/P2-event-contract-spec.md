# P2 Event Contract Specification

**Status:** Design Only (No Wiring Until P1 Hardening Merged)  
**Version:** 0.1.0  
**Date:** 2025-01-XX  

## Overview

This document specifies the event contracts for P2: Realized P&L Integration. Events enable post-trade economics to flow back into the guardrail system, closing the loop between decision-time projections and actual outcomes.

## Principal Decisions

### P&L Source Strategy: Hybrid

After analysis, the recommended approach is **Hybrid**:

| Source | Purpose | Latency | Authoritativeness |
|--------|---------|---------|-------------------|
| **Platform (Primary)** | Real-time fill notifications | <1s | Operational |
| **Back-office (Reconciliation)** | T+1 verified P&L | T+1 | Book of record |

**Rationale:**
- Platform provides immediate feedback for risk monitoring
- Back-office provides audit-grade figures for compliance
- Reconciliation logic handles discrepancies between sources

## Event Schemas

### 1. `execution.reported`

Emitted when a trade execution is reported by the platform (OMS/EMS).

```typescript
interface ExecutionReportedEvent {
  // Event envelope
  event_type: 'execution.reported';
  event_id: string;           // UUID v4
  event_timestamp: string;    // ISO 8601
  idempotency_key: string;    // `exec:{exec_id}`
  
  // Correlation
  decision_token: string;     // Links to original decision
  client_order_id: string;    // From order submission
  
  // Execution details
  exec_id: string;            // Exchange/OMS execution ID
  symbol: string;
  side: 'BUY' | 'SELL';
  fill_qty: number;
  fill_price: number;
  fill_currency: 'USD';       // MVP: USD only
  fill_timestamp: string;     // ISO 8601
  
  // Economics (platform-computed)
  realized_notional: number;  // fill_qty * fill_price
  commission?: number;
  fees?: number;
  
  // Source metadata
  source: 'PLATFORM' | 'BACKOFFICE';
  source_timestamp: string;
  source_sequence?: number;   // For ordering within source
}
```

**Idempotency:**
- Key format: `exec:{exec_id}`
- Duplicate events with same key are silently ignored
- Window: 7 days (configurable)

**Ordering:**
- Events may arrive out of order
- Consumer uses `fill_timestamp` for logical ordering
- `source_sequence` for total order within source

### 2. `position.closed`

Emitted when a position is closed (for P&L calculation).

```typescript
interface PositionClosedEvent {
  // Event envelope
  event_type: 'position.closed';
  event_id: string;           // UUID v4
  event_timestamp: string;    // ISO 8601
  idempotency_key: string;    // `close:{close_id}`
  
  // Correlation
  decision_token: string;     // Original decision (entry)
  closing_decision_token?: string; // Closing decision if guardrailed
  
  // Position details
  close_id: string;           // Unique close identifier
  symbol: string;
  entry_price: number;        // Weighted average entry
  exit_price: number;         // Weighted average exit
  qty: number;                // Position size closed
  
  // Realized P&L
  realized_pnl: number;       // (exit_price - entry_price) * qty * side_multiplier
  realized_pnl_currency: 'USD';
  pnl_source: 'PLATFORM' | 'BACKOFFICE';
  
  // Timing
  entry_timestamp: string;    // First fill of entry
  exit_timestamp: string;     // Last fill of exit
  holding_period_days: number;
  
  // Reconciliation
  reconciliation_status?: 'PENDING' | 'CONFIRMED' | 'DISCREPANCY';
  backoffice_pnl?: number;    // T+1 verified figure
  discrepancy_amount?: number;
}
```

**Idempotency:**
- Key format: `close:{close_id}`
- Close ID generated by position tracking service
- Re-reconciliation creates new event with new close_id

### 3. `economics.reconciled`

Emitted after back-office reconciliation (T+1).

```typescript
interface EconomicsReconciledEvent {
  // Event envelope
  event_type: 'economics.reconciled';
  event_id: string;
  event_timestamp: string;
  idempotency_key: string;    // `recon:{trade_date}:{symbol}:{account}`
  
  // Correlation
  decision_tokens: string[];  // All decisions in reconciliation window
  
  // Reconciliation details
  trade_date: string;         // YYYY-MM-DD
  symbol: string;
  account_id: string;
  
  // Platform vs Back-office comparison
  platform_pnl: number;
  backoffice_pnl: number;
  discrepancy: number;
  discrepancy_percent: number;
  
  // Resolution
  authoritative_pnl: number;  // Back-office wins for audit
  adjustment_required: boolean;
  adjustment_reason?: string;
}
```

## Event Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                        Event Timeline                            │
├──────────────┬──────────────┬──────────────┬───────────────────┤
│   T+0 (ms)   │  T+0 (sec)   │   T+1 (day)  │    Consumer       │
├──────────────┼──────────────┼──────────────┼───────────────────┤
│   Decision   │  execution.  │  economics.  │  Guardrail        │
│   Created    │  reported    │  reconciled  │  Shadow Ledger    │
│              │  (PLATFORM)  │  (BACKOFFICE)│                   │
├──────────────┼──────────────┼──────────────┼───────────────────┤
│              │  position.   │              │  Accuracy         │
│              │  closed      │              │  Metrics          │
│              │  (optional)  │              │                   │
└──────────────┴──────────────┴──────────────┴───────────────────┘
```

## Consumer: Shadow Ledger Updates

The Shadow Ledger will process events to update realized figures:

```typescript
interface ShadowLedgerUpdate {
  decision_token: string;
  
  // Projected (from decision time)
  projected_exposure_delta: number;
  projected_at: string;
  
  // Realized (from events)
  realized_exposure_delta?: number;
  realized_pnl?: number;
  realized_at?: string;
  
  // Accuracy metrics
  projection_accuracy?: number;  // 1 - |realized - projected| / projected
  slippage_bps?: number;         // Execution slippage
}
```

## Ordering & Consistency

### Ordering Rules

1. **Within Decision:** Events ordered by `fill_timestamp`
2. **Across Decisions:** No ordering guarantees (independent)
3. **Reconciliation:** Supersedes platform figures for same scope

### Consistency Model

| Scenario | Handling |
|----------|----------|
| Duplicate event | Idempotency key → ignore |
| Out-of-order fills | Aggregate by decision_token |
| Platform ≠ Back-office | Back-office authoritative for audit |
| Missing execution | Alert if position.closed without fills |

## Error Handling

### Dead Letter Queue (DLQ)

Events that fail processing after retry are sent to DLQ:

```typescript
interface DLQEntry {
  original_event: unknown;
  error_type: 'PARSE_ERROR' | 'VALIDATION_ERROR' | 'PROCESSING_ERROR';
  error_message: string;
  retry_count: number;
  first_failure_at: string;
  last_failure_at: string;
}
```

### Alerting Thresholds

| Metric | Warning | Critical |
|--------|---------|----------|
| DLQ depth | >10 | >100 |
| Processing latency p99 | >5s | >30s |
| Reconciliation discrepancy | >1% | >5% |

## Transport (Future Implementation)

**MVP Option:** HTTP webhook with retry
**Production Option:** Apache Kafka with exactly-once semantics

```typescript
// HTTP Webhook Contract
POST /events/execution
Content-Type: application/json
X-Idempotency-Key: exec:abc123
X-Event-Timestamp: 2025-01-15T10:30:00Z

{
  "event_type": "execution.reported",
  "event_id": "...",
  ...
}

// Response
200 OK - Event accepted
409 Conflict - Duplicate (idempotency key exists)
422 Unprocessable Entity - Validation error
```

## Testing Strategy

### Unit Tests
- Event schema validation
- Idempotency key generation
- P&L calculations

### Integration Tests
- End-to-end event flow
- Shadow ledger updates
- Reconciliation accuracy

### Property-Based Tests
- Event ordering invariants
- Idempotency guarantees
- Aggregate consistency

## Migration Path

### Phase 1: Schema & Contract (This Document)
- Define event schemas
- Document ordering rules
- Specify idempotency

### Phase 2: Consumer Implementation
- Shadow ledger event handlers
- Idempotency store
- DLQ infrastructure

### Phase 3: Producer Integration
- OMS/EMS webhook setup
- Back-office reconciliation feed
- Monitoring & alerting

---

## Appendix: Type Definitions

```typescript
// Full TypeScript definitions for implementation

type EventType = 'execution.reported' | 'position.closed' | 'economics.reconciled';

type Side = 'BUY' | 'SELL';

type PnLSource = 'PLATFORM' | 'BACKOFFICE';

type ReconciliationStatus = 'PENDING' | 'CONFIRMED' | 'DISCREPANCY';

// Base event envelope
interface EventEnvelope {
  event_type: EventType;
  event_id: string;
  event_timestamp: string;
  idempotency_key: string;
}

// Re-export event types
export type {
  ExecutionReportedEvent,
  PositionClosedEvent,
  EconomicsReconciledEvent,
  EventEnvelope,
  ShadowLedgerUpdate
};
```

---

**Next Steps:**
1. ✅ P1 hardening merged
2. Implement event handlers in Shadow Ledger
3. Create idempotency store (Redis or in-memory for MVP)
4. Wire up test event producer for validation

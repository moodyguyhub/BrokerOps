openapi: 3.1.0
info:
  title: BrokerOps Governance API
  version: 0.1.0
  description: |
    Governance-first operations infrastructure for brokerage platforms.
    
    **Core capabilities:**
    - Deterministic policy evaluation (OPA-backed)
    - Dual-control operator overrides
    - Tamper-evident audit trail (hash-chained)
    - Trace reconstruction with integrity verification
    - Decision economics tracking
    
    **Integration pattern:**
    All operations are linked by `traceId`. Given any traceId, you can reconstruct:
    - The original request
    - The policy decision (allow/block + reason + policy version)
    - Any overrides (who, why, approved by whom)
    - Economic impact (revenue, costs, lost revenue)
    - Full audit trail with cryptographic integrity
  contact:
    name: BrokerOps API Support
  license:
    name: Proprietary

servers:
  - url: http://localhost:7001
    description: Order API (local dev)
  - url: http://localhost:7004
    description: Reconstruction API (local dev)
  - url: http://localhost:7005
    description: Economics API (local dev)

tags:
  - name: Authorization
    description: |
      **P3 Gate Contract Endpoints**
      
      Pre-trade authorization with cryptographic decision tokens.
      BrokerOps is decision authority; trading platform is execution authority.
  - name: Orders
    description: Order submission and decision flow
  - name: Overrides
    description: Dual-control operator override workflow
  - name: Traces
    description: Trace reconstruction and evidence
  - name: Economics
    description: Decision economics tracking
  - name: Webhooks
    description: Event notifications for external systems
  - name: Playground
    description: Policy dry-run and testing endpoints

paths:
  # ============================================================================
  # Authorization Gate (P3 Contract)
  # ============================================================================
  /v1/authorize:
    post:
      tags: [Authorization]
      summary: Pre-trade authorization gate
      description: |
        **Primary authorization endpoint for BrokerOps Gate Contract.**
        
        Evaluates an order against active policy and returns a signed Decision Token.
        This is the canonical authorization interface for trading platforms.
        
        **Authority Boundary:**
        - BrokerOps is the **decision authority** (AUTHORIZED/BLOCKED)
        - Trading platform remains **execution authority**
        - Decision Token is proof of authorization, not execution instruction
        
        **Latency SLO (topology-dependent):**
        - Same-host/LAN: p99 < 50ms (revised per P0-PERF-2026-01-16 evidence)
        - Cross-region: Consult deployment-specific SLO
        
        **HTTP Status Semantics:**
        - Always returns HTTP 200 for valid requests
        - The `status` field indicates decision: AUTHORIZED or BLOCKED
        - HTTP 4xx reserved for invalid requests (schema errors)
        - HTTP 503 reserved for gate unavailable (fail-closed)
        
        **Failure Mode (PD-5: FAIL-CLOSED):**
        - If audit service unavailable: returns BLOCKED with reason_code=AUDIT_UNAVAILABLE
        - Process does NOT crash; returns stable error shape
        
        **Response includes:**
        - `decision_token`: Signed proof of authorization (HMAC-SHA256)
        - `status`: AUTHORIZED or BLOCKED
        - `advisory_routing_class` (optional): Non-binding classification hint
        - `timing_ms`: Segment timing breakdown for performance analysis
      operationId: authorizeOrder
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthorizeRequest'
            example:
              order:
                client_order_id: "ORD-2026-001"
                symbol: "AAPL"
                side: "BUY"
                qty: 100
                price: 185.50
              context:
                client_id: "CL-001"
                account_type: "RETAIL"
      responses:
        '200':
          description: Authorization decision issued
          headers:
            X-Decision-Latency-Ms:
              description: Server-side decision latency in milliseconds
              schema:
                type: number
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthorizeResponse'
              examples:
                authorized:
                  summary: Order authorized
                  value:
                    trace_id: "f4826a78-663e-4fb9-98a7-c3d42ac21517"
                    status: "AUTHORIZED"
                    decision_token:
                      version: "v1"
                      payload:
                        trace_id: "f4826a78-663e-4fb9-98a7-c3d42ac21517"
                        decision: "AUTHORIZED"
                        reason_code: "OK"
                        issued_at: "2026-01-15T10:00:00.000Z"
                        expires_at: "2026-01-15T10:05:00.000Z"
                      signature: "abc123..."
                    advisory_routing_class: null
                    gate_note: "Decision Token issued. Trading platform remains execution master."
                blocked:
                  summary: Order blocked by policy
                  value:
                    trace_id: "f4826a78-663e-4fb9-98a7-c3d42ac21517"
                    status: "BLOCKED"
                    decision_token:
                      version: "v1"
                      payload:
                        trace_id: "f4826a78-663e-4fb9-98a7-c3d42ac21517"
                        decision: "BLOCKED"
                        reason_code: "EXPOSURE_LIMIT_EXCEEDED"
                        rule_ids: ["max_exposure"]
                        issued_at: "2026-01-15T10:00:00.000Z"
                        expires_at: "2026-01-15T10:05:00.000Z"
                      signature: "def456..."
                    advisory_routing_class: null
        '400':
          description: Invalid request schema
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '503':
          description: Gate unavailable (fail-closed)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GateUnavailableError'

  # ============================================================================
  # Orders (Legacy - maps to /v1/authorize internally)
  # ============================================================================
  /orders:
    post:
      tags: [Orders]
      summary: Submit order for policy evaluation
      description: |
        Submits an order request through the risk policy engine.
        Returns immediately with decision (ACCEPTED or BLOCKED).
        All decisions are audited with full trace reconstruction available.
      operationId: submitOrder
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrderRequest'
            example:
              clientOrderId: "ORD-2026-001"
              symbol: "AAPL"
              side: "BUY"
              qty: 100
              price: 185.50
      responses:
        '200':
          description: Order processed (may be ACCEPTED or BLOCKED)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderResponse'
              examples:
                accepted:
                  summary: Order accepted
                  value:
                    traceId: "f4826a78-663e-4fb9-98a7-c3d42ac21517"
                    status: "ACCEPTED"
                    decision: "ALLOW"
                    reasonCode: "APPROVED"
                    policyVersion: "policy.v0.2"
                blocked:
                  summary: Order blocked by policy
                  value:
                    traceId: "f4826a78-663e-4fb9-98a7-c3d42ac21517"
                    status: "BLOCKED"
                    decision: "BLOCK"
                    reasonCode: "SYMBOL_RESTRICTION"
                    policyVersion: "policy.v0.2"
                    ruleId: "symbol_gme"
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ============================================================================
  # Playground (Dry-Run)
  # ============================================================================
  /dry-run:
    post:
      tags: [Playground]
      summary: Evaluate policy without persisting (dry-run)
      description: |
        Test how the guardrail engine would evaluate an order without creating
        any audit records. Useful for:
        - Testing new policies before deployment
        - Validating order parameters before submission
        - Training and documentation
        
        **Important:** No data is persisted, no traceId is generated.
      operationId: dryRunEvaluate
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrderRequest'
            example:
              clientOrderId: "test-001"
              symbol: "AAPL"
              side: "BUY"
              qty: 100
              price: 150.00
      responses:
        '200':
          description: Policy evaluation result (not persisted)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DryRunResponse'
              examples:
                would_allow:
                  summary: Order would be allowed
                  value:
                    decision: "ALLOW"
                    allow: true
                    reasonCode: "OK"
                    policyVersion: "policy.v0.2"
                    dryRun: true
                would_block:
                  summary: Order would be blocked
                  value:
                    decision: "BLOCK"
                    allow: false
                    reasonCode: "QTY_LIMIT_EXCEEDED"
                    ruleId: "qty_limit"
                    policyVersion: "policy.v0.2"
                    dryRun: true
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ============================================================================
  # Overrides (Dual-Control)
  # ============================================================================
  /override/{traceId}/request:
    post:
      tags: [Overrides]
      summary: Request operator override
      description: |
        First step of dual-control override workflow.
        Operator requests to override a blocked decision.
        Requires approval from a different operator.
      operationId: requestOverride
      parameters:
        - $ref: '#/components/parameters/traceId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OverrideRequest'
            example:
              operatorId: "ops-alice"
              reason: "Client is verified institutional, exception approved by compliance"
              newDecision: "ALLOW"
      responses:
        '200':
          description: Override requested
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OverrideRequestResponse'
        '404':
          description: Trace not found
        '409':
          description: Override already exists for this trace

  /override/{traceId}/approve:
    post:
      tags: [Overrides]
      summary: Approve override (dual-control)
      description: |
        Second step of dual-control override workflow.
        A different operator approves the override request.
        **Dual-control enforced:** Approver must be different from requester.
      operationId: approveOverride
      parameters:
        - $ref: '#/components/parameters/traceId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OverrideApproval'
            example:
              operatorId: "ops-bob"
              comment: "Reviewed and approved per compliance exception process"
      responses:
        '200':
          description: Override approved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OverrideApprovalResponse'
        '403':
          description: Dual-control violation (same operator)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "DUAL_CONTROL_VIOLATION"
                message: "Approver must be different from requester"
        '404':
          description: No pending override for this trace

  /override/{traceId}/reject:
    post:
      tags: [Overrides]
      summary: Reject override request
      description: Reject a pending override request with reason.
      operationId: rejectOverride
      parameters:
        - $ref: '#/components/parameters/traceId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OverrideRejection'
      responses:
        '200':
          description: Override rejected
        '404':
          description: No pending override for this trace

  # ============================================================================
  # Trace Reconstruction
  # ============================================================================
  /trace/{traceId}:
    get:
      tags: [Traces]
      summary: Get raw trace events
      description: Returns all audit events for a trace (unverified).
      operationId: getTrace
      parameters:
        - $ref: '#/components/parameters/traceId'
      responses:
        '200':
          description: Trace events
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TraceEvents'

  /trace/{traceId}/bundle:
    get:
      tags: [Traces]
      summary: Get trace bundle (integrity verified)
      description: |
        Returns complete trace bundle with:
        - Summary (decision, policy, override status, economic impact)
        - Full event timeline
        - Hash chain for integrity verification
        
        **Fail-closed:** Returns 500 if hash chain integrity fails.
        This is the primary artifact for audit/compliance review.
      operationId: getTraceBundle
      parameters:
        - $ref: '#/components/parameters/traceId'
      responses:
        '200':
          description: Trace bundle (integrity verified)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TraceBundle'
        '404':
          description: Trace not found
        '500':
          description: Audit chain integrity failure (possible tampering)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IntegrityFailure'

  # ============================================================================
  # Economics
  # ============================================================================
  /economics/event:
    post:
      tags: [Economics]
      summary: Record economic event
      description: |
        Record an economic impact event linked to a traceId.
        Events are append-only and hash-chained.
        
        **Use cases:**
        - Trade blocked → record estimatedLostRevenue
        - Trade executed → record grossRevenue, fees, costs
        - Override approved → record revenue recovered
      operationId: recordEconomicEvent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EconomicEvent'
            example:
              traceId: "f4826a78-663e-4fb9-98a7-c3d42ac21517"
              type: "TRADE_BLOCKED"
              estimatedLostRevenue: 12.50
              currency: "USD"
              source: "execution"
              policyId: "symbol_gme"
      responses:
        '200':
          description: Event recorded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EconomicEventResponse'

  /economics/trace/{traceId}:
    get:
      tags: [Economics]
      summary: Get economics for a trace
      description: Returns all economic events and summary for a specific trace.
      operationId: getTraceEconomics
      parameters:
        - $ref: '#/components/parameters/traceId'
      responses:
        '200':
          description: Trace economics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TraceEconomics'

  /economics/summary:
    get:
      tags: [Economics]
      summary: Get aggregate economic summary
      description: |
        Returns aggregate economic metrics across all traces.
        Includes breakdowns by policy and override status.
      operationId: getEconomicsSummary
      responses:
        '200':
          description: Economic summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EconomicsSummary'

  # ============================================================================
  # Webhooks
  # ============================================================================
  /webhooks:
    get:
      tags: [Webhooks]
      summary: List registered webhooks
      operationId: listWebhooks
      responses:
        '200':
          description: List of webhooks
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Webhook'
    post:
      tags: [Webhooks]
      summary: Register a webhook
      description: |
        Register a URL to receive event notifications.
        
        **Available events:**
        - `trace.completed` - Order processed (accepted or blocked)
        - `override.requested` - Operator requested override
        - `override.approved` - Override approved (dual-control verified)
        - `override.rejected` - Override rejected
        - `economics.recorded` - Economic event recorded
      operationId: registerWebhook
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookRegistration'
            example:
              url: "https://crm.example.com/webhooks/brokerops"
              events: ["trace.completed", "override.approved"]
              secret: "whsec_abc123..."
      responses:
        '201':
          description: Webhook registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Webhook'

  /webhooks/{webhookId}:
    delete:
      tags: [Webhooks]
      summary: Delete a webhook
      operationId: deleteWebhook
      parameters:
        - name: webhookId
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Webhook deleted

  # ============================================================================
  # Export Endpoints (Week 5 - Evidence Pack / Dispute Pack)
  # ============================================================================
  /api/export/evidence-pack:
    get:
      tags: [Traces]
      summary: System-wide evidence bundle
      description: |
        Returns current system state snapshot for demo/audit purposes.
        Includes orders, alerts, LP accounts, snapshots, and checksums.
      operationId: getSystemEvidencePack
      responses:
        '200':
          description: Evidence pack generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EvidencePackResponse'
        '500':
          description: Internal server error

  /api/export/bundle:
    get:
      tags: [Traces]
      summary: Alias for evidence-pack
      description: Alias endpoint for evidence-pack (script compatibility)
      operationId: getSystemBundle
      responses:
        '200':
          description: Evidence pack generated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EvidencePackResponse'

  /api/orders/{orderId}/evidence-pack:
    get:
      tags: [Traces]
      summary: Order-specific evidence pack
      description: |
        Returns complete audit trail for a specific order including:
        - Order details
        - Lifecycle events (hash-chained)
        - Related audit events
        - Related alerts
        - Checksums for each component
      operationId: getOrderEvidencePack
      parameters:
        - name: orderId
          in: path
          required: true
          description: Order ID (trace_id)
          schema:
            type: string
      responses:
        '200':
          description: Order evidence pack generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrderEvidencePackResponse'
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'

  /api/orders/{orderId}/dispute-pack:
    get:
      tags: [Traces]
      summary: Dispute bundle for an order
      description: |
        Returns order + lifecycle + rejection details + related alerts.
        Optimized for dispute resolution and regulatory inquiries.
        
        Includes:
        - Order summary
        - Full lifecycle event chain
        - Rejection details (if applicable)
        - Related alerts within 1 hour window
        - LP context snapshot at order time
        - Component checksums
      operationId: getOrderDisputePack
      parameters:
        - name: orderId
          in: path
          required: true
          description: Order ID (trace_id)
          schema:
            type: string
      responses:
        '200':
          description: Dispute pack generated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DisputePackResponse'
        '404':
          description: Order not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApiErrorResponse'

components:
  parameters:
    traceId:
      name: traceId
      in: path
      required: true
      description: Unique trace identifier (UUID)
      schema:
        type: string
        format: uuid

  schemas:
    # --- Authorization Gate (P3) ---
    AuthorizeRequest:
      type: object
      required: [order]
      properties:
        order:
          type: object
          required: [client_order_id, symbol, side, qty]
          properties:
            client_order_id:
              type: string
              minLength: 3
              description: Client-provided order identifier (idempotency key)
            symbol:
              type: string
              minLength: 1
              description: Trading symbol (e.g., AAPL, GME)
            side:
              type: string
              enum: [BUY, SELL]
            qty:
              type: integer
              minimum: 1
              description: Order quantity
            price:
              type: number
              minimum: 0
              description: Limit price (optional for market orders)
        context:
          type: object
          description: Optional context for policy evaluation
          properties:
            client_id:
              type: string
              description: Client identifier for exposure tracking
            account_type:
              type: string
              enum: [RETAIL, PROFESSIONAL, INSTITUTIONAL]
            session_id:
              type: string
              description: Trading session identifier

    AuthorizeResponse:
      type: object
      required: [trace_id, status, decision_token]
      properties:
        trace_id:
          type: string
          format: uuid
          description: Unique trace ID linking to audit chain
        status:
          type: string
          enum: [AUTHORIZED, BLOCKED]
          description: |
            Authorization decision.
            - AUTHORIZED: Order may proceed to execution
            - BLOCKED: Order should not be executed
        decision_token:
          $ref: '#/components/schemas/DecisionToken'
        advisory_routing_class:
          type: string
          enum: [A_BOOK, B_BOOK, HYBRID]
          nullable: true
          description: |
            **Non-binding** classification hint.
            Trading platform MAY ignore this entirely.
            Included for analytics/reporting only.
        reason_code:
          type: string
          description: Human-readable reason code
        rule_ids:
          type: array
          items:
            type: string
          description: Policy rules that contributed to decision
        policy_version:
          type: string
          description: Version of policy used for decision
        gate_note:
          type: string
          description: Informational note about gate contract semantics
        timing_ms:
          type: object
          description: |
            Segment timing breakdown for performance analysis (P0-PERF).
            All values in milliseconds.
          properties:
            parse_validate:
              type: number
              description: Time to parse and validate request schema
            audit_request:
              type: number
              description: Time to audit request event
            policy_decision:
              type: number
              description: Time for risk-gate + OPA policy evaluation
            audit_risk:
              type: number
              description: Time to audit risk evaluation
            economics:
              type: number
              description: Time to compute snapshot economics
            token_sign:
              type: number
              description: Time to sign decision token
            audit_decision:
              type: number
              description: Time to audit final decision
            webhook:
              type: number
              description: Time to emit webhook
            total:
              type: number
              description: Total request latency

    DecisionToken:
      type: object
      description: |
        Cryptographic proof of authorization decision.
        
        **Verification procedure:**
        1. Extract payload from token
        2. Canonicalize: JSON.stringify(payload, Object.keys(payload).sort())
        3. HMAC-SHA256(canonical, signing_key)
        4. Compare to token.signature
      required: [version, payload, signature]
      properties:
        version:
          type: string
          enum: [v1]
          description: Token version for compatibility
        payload:
          $ref: '#/components/schemas/DecisionTokenPayload'
        signature:
          type: string
          description: HMAC-SHA256 signature of canonical payload

    DecisionTokenPayload:
      type: object
      required: [trace_id, decision, reason_code, issued_at, expires_at, nonce, subject, audience, order]
      properties:
        trace_id:
          type: string
          format: uuid
        decision:
          type: string
          enum: [AUTHORIZED, BLOCKED]
        reason_code:
          type: string
        rule_ids:
          type: array
          items:
            type: string
        policy_snapshot_hash:
          type: string
          description: SHA-256 hash of policy used for decision
        issued_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
          description: Token validity window (default 5 minutes)
        nonce:
          type: string
          description: Random nonce to prevent replay
        subject:
          type: string
          description: Subject identifier (client/account)
        audience:
          type: string
          description: Audience (trading platform)
        order:
          type: object
          properties:
            symbol:
              type: string
            side:
              type: string
            qty:
              type: integer
            price:
              type: number
            client_order_id:
              type: string
        projected_exposure:
          type: number
          description: Projected exposure at decision time
        order_digest:
          type: string
          pattern: ^[a-f0-9]{64}$
          description: |
            SHA-256 digest of canonical order content.
            Format: SHA256("{client_order_id}|{SYMBOL}|{SIDE}|{qty}|{price}")
            Enables execution verification - if executed order differs
            from authorized order, digest will not match.
        order_digest_version:
          type: string
          enum: [v1]
          description: Order digest algorithm version for forward compatibility

    GateUnavailableError:
      type: object
      description: |
        Fail-closed error when gate cannot make a decision.
        Trading platform should NOT proceed with order.
      properties:
        error:
          type: string
          enum: [GATE_UNAVAILABLE, AUDIT_UNAVAILABLE, STATE_UNAVAILABLE, SIGNING_UNAVAILABLE]
        message:
          type: string
        retry_after_ms:
          type: integer
          description: Suggested retry delay in milliseconds

    # --- Orders ---
    OrderRequest:
      type: object
      required: [clientOrderId, symbol, side, qty]
      properties:
        clientOrderId:
          type: string
          minLength: 3
          description: Client-provided order identifier
        symbol:
          type: string
          minLength: 1
          description: Trading symbol (e.g., AAPL, GME)
        side:
          type: string
          enum: [BUY, SELL]
        qty:
          type: integer
          minimum: 1
          description: Order quantity
        price:
          type: number
          minimum: 0
          description: Limit price (optional for market orders)

    OrderResponse:
      type: object
      properties:
        traceId:
          type: string
          format: uuid
          description: Unique trace ID for this order flow
        status:
          type: string
          enum: [ACCEPTED, BLOCKED]
        decision:
          type: string
          enum: [ALLOW, BLOCK]
        reasonCode:
          type: string
          description: Policy reason code
        policyVersion:
          type: string
          description: Version of policy that made the decision
        ruleId:
          type: string
          description: Specific rule that triggered (for BLOCK decisions)

    # --- Dry-Run (Playground) ---
    DryRunResponse:
      type: object
      properties:
        decision:
          type: string
          enum: [ALLOW, BLOCK]
          description: Policy decision
        allow:
          type: boolean
          description: Whether order would be allowed
        reasonCode:
          type: string
          description: Reason code for the decision
        ruleId:
          type: string
          description: Rule that triggered (for BLOCK decisions)
        policyVersion:
          type: string
          description: Version of policy evaluated
        dryRun:
          type: boolean
          const: true
          description: Indicates this was a dry-run (always true)

    # --- Overrides ---
    OverrideRequest:
      type: object
      required: [operatorId, reason, newDecision]
      properties:
        operatorId:
          type: string
          description: Operator requesting the override
        reason:
          type: string
          description: Business justification for override
        newDecision:
          type: string
          enum: [ALLOW]
          description: Requested new decision

    OverrideRequestResponse:
      type: object
      properties:
        status:
          type: string
          enum: [OVERRIDE_REQUESTED]
        traceId:
          type: string
        requestedBy:
          type: string
        requiresApprovalFrom:
          type: string
          description: "Different operator required"

    OverrideApproval:
      type: object
      required: [operatorId]
      properties:
        operatorId:
          type: string
          description: Operator approving (must differ from requester)
        comment:
          type: string
          description: Approval comment

    OverrideApprovalResponse:
      type: object
      properties:
        status:
          type: string
          enum: [OVERRIDE_APPROVED]
        traceId:
          type: string
        requestedBy:
          type: string
        approvedBy:
          type: string
        dualControlVerified:
          type: boolean

    OverrideRejection:
      type: object
      required: [operatorId, reason]
      properties:
        operatorId:
          type: string
        reason:
          type: string

    # --- Traces ---
    TraceEvents:
      type: object
      properties:
        traceId:
          type: string
        count:
          type: integer
        events:
          type: array
          items:
            $ref: '#/components/schemas/AuditEvent'

    AuditEvent:
      type: object
      properties:
        id:
          type: string
        traceId:
          type: string
        eventType:
          type: string
        eventVersion:
          type: string
        payloadJson:
          type: object
        prevHash:
          type: string
          nullable: true
        hash:
          type: string
        createdAt:
          type: string
          format: date-time

    TraceBundle:
      type: object
      properties:
        version:
          type: string
          example: "bundle.v2"
        generatedAt:
          type: string
          format: date-time
        integrityVerified:
          type: boolean
        summary:
          $ref: '#/components/schemas/TraceSummary'
        hashChain:
          type: array
          items:
            $ref: '#/components/schemas/HashChainEntry'
        events:
          type: array
          items:
            $ref: '#/components/schemas/AuditEvent'

    TraceSummary:
      type: object
      properties:
        traceId:
          type: string
        outcome:
          type: string
          enum: [ACCEPTED, BLOCKED]
        decision:
          type: string
        reasonCode:
          type: string
        ruleId:
          type: string
          nullable: true
        policyVersion:
          type: string
        hasOverride:
          type: boolean
        overrideBy:
          type: string
          nullable: true
        overrideReason:
          type: string
          nullable: true
        economicImpact:
          $ref: '#/components/schemas/EconomicImpact'
        order:
          $ref: '#/components/schemas/OrderRequest'
        eventCount:
          type: integer
        hashChainValid:
          type: boolean
        hashChainVerified:
          type: boolean

    HashChainEntry:
      type: object
      properties:
        seq:
          type: integer
        eventType:
          type: string
        hash:
          type: string
        prevHash:
          type: string
          nullable: true
        timestamp:
          type: string
          format: date-time

    IntegrityFailure:
      type: object
      properties:
        error:
          type: string
          example: "AUDIT_CHAIN_INTEGRITY_FAILURE"
        traceId:
          type: string
        verification:
          type: object
          properties:
            valid:
              type: boolean
            brokenAt:
              type: integer
            reason:
              type: string
        message:
          type: string
        action:
          type: string
          example: "Contact security team immediately"

    # --- Economics ---
    EconomicEvent:
      type: object
      required: [traceId, type]
      properties:
        traceId:
          type: string
          format: uuid
        type:
          type: string
          enum: [TRADE_EXECUTED, TRADE_BLOCKED, OVERRIDE_APPROVED, OVERRIDE_DENIED]
        grossRevenue:
          type: number
        fees:
          type: number
        costs:
          type: number
        estimatedLostRevenue:
          type: number
        currency:
          type: string
          default: "USD"
        source:
          type: string
          description: Origin system (e.g., crm, execution, ops)
        policyId:
          type: string
          description: Policy rule for attribution

    EconomicEventResponse:
      type: object
      properties:
        ok:
          type: boolean
        traceId:
          type: string
        hash:
          type: string
          description: Hash of this event in the chain

    EconomicImpact:
      type: object
      nullable: true
      properties:
        estimatedLostRevenue:
          type: number
        grossRevenue:
          type: number
        currency:
          type: string

    TraceEconomics:
      type: object
      properties:
        traceId:
          type: string
        events:
          type: array
          items:
            $ref: '#/components/schemas/EconomicEvent'
        summary:
          type: object
          properties:
            totalRevenue:
              type: number
            totalCosts:
              type: number
            estimatedLostRevenue:
              type: number
            currency:
              type: string

    EconomicsSummary:
      type: object
      properties:
        totalRevenue:
          type: number
        totalCosts:
          type: number
        netImpact:
          type: number
        lostRevenue:
          type: number
        byPolicy:
          type: object
          additionalProperties:
            type: number
        byOverride:
          type: object
          properties:
            approved:
              type: number
            denied:
              type: number

    # --- Webhooks ---
    WebhookRegistration:
      type: object
      required: [url, events]
      properties:
        url:
          type: string
          format: uri
          description: HTTPS endpoint to receive events
        events:
          type: array
          items:
            type: string
            enum:
              - trace.completed
              - override.requested
              - override.approved
              - override.rejected
              - economics.recorded
        secret:
          type: string
          description: Shared secret for HMAC signature verification

    Webhook:
      type: object
      properties:
        id:
          type: string
        url:
          type: string
        events:
          type: array
          items:
            type: string
        createdAt:
          type: string
          format: date-time
        active:
          type: boolean

    # --- Common ---
    Error:
      type: object
      properties:
        error:
          type: string
        message:
          type: string

    # --- Export Endpoints (Week 5) ---
    ApiErrorResponse:
      type: object
      properties:
        success:
          type: boolean
          example: false
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string

    EvidencePackResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        data:
          type: object
          properties:
            type:
              type: string
              example: "evidence-pack"
            version:
              type: string
              example: "1.0.0"
            generated_at:
              type: string
              format: date-time
            generator:
              type: object
              properties:
                commit:
                  type: string
                built_at:
                  type: string
                service:
                  type: string
            summary:
              type: object
              properties:
                orders_count:
                  type: integer
                alerts_count:
                  type: integer
                lp_accounts_count:
                  type: integer
                lp_snapshots_count:
                  type: integer
                audit_events_count:
                  type: integer
            bundle:
              type: object
              description: Raw data bundle containing orders, alerts, lp_accounts, etc.
            checksums:
              type: object
              properties:
                orders:
                  type: string
                alerts:
                  type: string
                lp_accounts:
                  type: string
                lp_snapshots:
                  type: string
                alert_settings:
                  type: string
                bundle:
                  type: string
        meta:
          type: object
          properties:
            checksum:
              type: string
              description: First 16 chars of bundle checksum

    OrderEvidencePackResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            type:
              type: string
              example: "order-evidence-pack"
            version:
              type: string
            order_id:
              type: string
            generated_at:
              type: string
              format: date-time
            summary:
              type: object
              properties:
                order_status:
                  type: string
                lifecycle_event_count:
                  type: integer
                audit_event_count:
                  type: integer
                related_alert_count:
                  type: integer
            components:
              type: object
              properties:
                order:
                  type: object
                lifecycle_events:
                  type: array
                  items:
                    type: object
                audit_events:
                  type: array
                  items:
                    type: object
                related_alerts:
                  type: array
                  items:
                    type: object
            checksums:
              type: object

    DisputePackResponse:
      type: object
      properties:
        success:
          type: boolean
        data:
          type: object
          properties:
            type:
              type: string
              example: "dispute-pack"
            version:
              type: string
            order_id:
              type: string
            generated_at:
              type: string
              format: date-time
            summary:
              type: object
              properties:
                order_status:
                  type: string
                has_rejection:
                  type: boolean
                lifecycle_event_count:
                  type: integer
                related_alert_count:
                  type: integer
                has_lp_context:
                  type: boolean
            data:
              type: object
              properties:
                order:
                  type: object
                lifecycle:
                  type: array
                  items:
                    type: object
                rejection:
                  type: object
                  nullable: true
                alerts:
                  type: array
                  items:
                    type: object
                lp_context:
                  type: object
                  nullable: true
            checksums:
              type: object

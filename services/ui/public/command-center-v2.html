<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TRUVESTA Command Center v2</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets/ui.css">
  <style>
    /* Page-specific overrides */
    .shell-logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .shell-logo-icon {
      width: 32px;
      height: 32px;
      background: var(--cyan-500);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      transform: rotate(3deg);
    }

    .shell-logo-icon svg {
      color: var(--slate-950);
      width: 18px;
      height: 18px;
    }

    .shell-logo-text {
      font-size: 1.125rem;
      font-weight: 700;
      color: white;
      letter-spacing: -0.02em;
    }

    .shell-logo-version {
      font-size: 0.625rem;
      color: var(--slate-500);
      font-family: 'JetBrains Mono', monospace;
      background: var(--slate-800);
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 4px;
    }

    /* Embed container */
    .embed-container {
      width: 100%;
      height: calc(100vh - 120px);
      border: none;
      border-radius: var(--radius-lg);
      background: var(--slate-900);
    }

    .embed-container iframe {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: var(--radius-lg);
    }

    /* Quick action buttons */
    .quick-actions {
      display: flex;
      gap: var(--spacing-sm);
    }

    .quick-action-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: var(--radius-md);
      font-size: 0.8125rem;
      font-weight: 500;
      background: var(--slate-800);
      color: var(--slate-300);
      border: 1px solid var(--slate-700);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .quick-action-btn:hover {
      background: var(--slate-700);
      border-color: var(--slate-600);
    }

    .quick-action-btn svg {
      width: 14px;
      height: 14px;
    }

    /* Loading state */
    .loading-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--slate-900);
      border-radius: var(--radius-lg);
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--slate-700);
      border-top-color: var(--cyan-500);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Tab content wrapper - account for provenance footer */
    .tab-content-wrapper {
      position: relative;
      min-height: calc(100vh - 120px - 24px);
    }

    /* Embed container adjustment for footer */
    .embed-container {
      height: calc(100vh - 120px - 24px) !important;
    }

    /* Header Connection Indicator */
    .header-connection {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: var(--radius-md);
      background: var(--slate-800);
      border: 1px solid var(--slate-700);
      font-size: 0.75rem;
    }

    .connection-shape {
      width: 10px;
      height: 10px;
      display: inline-block;
    }

    .connection-shape.ok {
      background: var(--emerald-500);
      border-radius: 50%;
    }

    .connection-shape.warn {
      width: 0;
      height: 0;
      border-left: 5px solid transparent;
      border-right: 5px solid transparent;
      border-bottom: 10px solid var(--amber-500);
    }

    .connection-shape.error {
      background: var(--red-500);
      border-radius: 2px;
    }

    .connection-shape.loading {
      background: var(--slate-500);
      border-radius: 50%;
      animation: pulse 1.5s ease-in-out infinite;
    }

    .connection-text {
      color: var(--slate-300);
      font-weight: 500;
    }

    .connection-latency {
      color: var(--slate-500);
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.6875rem;
    }
  </style>
</head>
<body>
  <!-- Top Bar -->
  <header class="shell-topbar">
    <div class="shell-topbar-left">
      <div class="shell-logo">
        <div class="shell-logo-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
          </svg>
        </div>
        <span class="shell-logo-text">TRUVESTA</span>
        <span class="shell-logo-version">v2</span>
      </div>
      
      <span class="env-badge demo">
        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
        </svg>
        DEMO
      </span>

      <!-- Global Shell Controls -->
      <div class="shell-controls">
        <div class="shell-control-group">
          <span class="shell-control-label">Server</span>
          <select class="shell-select" id="global-server-select">
            <option value="all" selected>All Servers</option>
            <option value="demo-1">Demo Server 1</option>
            <option value="demo-2">Demo Server 2</option>
          </select>
        </div>
        <div class="shell-control-group">
          <span class="shell-control-label">Window</span>
          <select class="shell-select" id="global-time-window">
            <option value="15m">15 min</option>
            <option value="1h">1 hour</option>
            <option value="6h">6 hours</option>
            <option value="24h" selected>24 hours</option>
            <option value="7d">7 days</option>
          </select>
        </div>
      </div>
    </div>

    <div class="shell-topbar-right">
      <!-- Search Trigger -->
      <button class="search-trigger" id="global-search-trigger" title="Search (/)">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="8"/>
          <path d="M21 21l-4.35-4.35"/>
        </svg>
        Search
        <kbd>/</kbd>
      </button>

      <!-- Alerts Badge -->
      <button class="header-alerts-badge" id="global-alerts-badge-btn" title="View Alerts">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
          <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
        </svg>
        <span class="badge-count" id="global-alerts-badge" style="display: none;">0</span>
      </button>

      <div class="quick-actions">
        <button class="quick-action-btn" id="btn-refresh" title="Refresh current view">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
            <path d="M3 3v5h5"/>
            <path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/>
            <path d="M16 21h5v-5"/>
          </svg>
          Refresh
        </button>
      </div>

      <!-- System Status -->
      <span class="system-status system-status-ok" id="global-system-status" title="System OK"></span>

      <!-- Header Connection Indicator -->
      <div class="header-connection" id="header-connection" role="status" aria-label="Infrastructure connection status">
        <span class="connection-shape" id="connection-shape"></span>
        <span class="connection-text" id="connection-text">--</span>
        <span class="connection-latency" id="connection-latency"></span>
      </div>

      <div class="status-indicator">
        <span class="status-dot" id="shell-status-dot"></span>
        <span id="shell-status-text">Connected</span>
      </div>

      <div class="shell-topbar-links">
        <a href="/dashboard" target="_blank" title="Open Dashboard in new tab">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
            <polyline points="15,3 21,3 21,9"/>
            <line x1="10" y1="14" x2="21" y2="3"/>
          </svg>
          Dashboard
        </a>
        <a href="/api/health" target="_blank" title="API Health">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
          </svg>
          Health
        </a>
      </div>
    </div>
  </header>

  <!-- Main Layout -->
  <div class="shell-layout">
    <!-- Sidebar Navigation -->
    <nav class="shell-sidebar">
      <div class="shell-sidebar-nav">
        <button class="shell-sidebar-item active" id="tab-dashboard" data-tab="dashboard" title="Dashboard Overview">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="3" y="3" width="7" height="7"/>
            <rect x="14" y="3" width="7" height="7"/>
            <rect x="14" y="14" width="7" height="7"/>
            <rect x="3" y="14" width="7" height="7"/>
          </svg>
          <span>Dashboard</span>
        </button>

        <button class="shell-sidebar-item" id="tab-orders" data-tab="orders" title="Order Management">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14,2 14,8 20,8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
            <polyline points="10,9 9,9 8,9"/>
          </svg>
          <span>Orders</span>
        </button>

        <button class="shell-sidebar-item" id="tab-lps" data-tab="lps" title="LP Accounts">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="1" x2="12" y2="23"/>
            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
          </svg>
          <span>LPs</span>
        </button>

        <button class="shell-sidebar-item" id="tab-alerts" data-tab="alerts" title="Alerts & Notifications">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
          </svg>
          <span>Alerts</span>
          <span class="item-badge" id="alerts-badge" style="display: none;">0</span>
        </button>

        <button class="shell-sidebar-item" id="tab-demo" data-tab="demo" title="Demo Controls">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="5,3 19,12 5,21 5,3"/>
          </svg>
          <span>Demo</span>
        </button>

        <button class="shell-sidebar-item" id="tab-infra" data-tab="infra" title="Infrastructure Status">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="2" y="2" width="20" height="8" rx="2" ry="2"/>
            <rect x="2" y="14" width="20" height="8" rx="2" ry="2"/>
            <line x1="6" y1="6" x2="6.01" y2="6"/>
            <line x1="6" y1="18" x2="6.01" y2="18"/>
          </svg>
          <span>Infra</span>
          <span class="item-badge" id="infra-badge" style="display: none;"></span>
        </button>
      </div>
    </nav>

    <!-- Main Content Area -->
    <main class="shell-main">
      <div class="tab-content-wrapper">
        <!-- Dashboard Tab -->
        <section class="tab-panel active" id="panel-dashboard">
          <div class="embed-container" id="embed-dashboard">
            <iframe src="/dashboard?embed=1" title="Dashboard" loading="lazy"></iframe>
          </div>
        </section>

        <!-- Orders Tab -->
        <section class="tab-panel" id="panel-orders">
          <div class="embed-container" id="embed-orders">
            <iframe src="/orders?embed=1" title="Orders" loading="lazy"></iframe>
          </div>
        </section>

        <!-- LPs Tab -->
        <section class="tab-panel" id="panel-lps">
          <div class="embed-container" id="embed-lps">
            <iframe src="/lp-accounts?embed=1" title="LP Accounts" loading="lazy"></iframe>
          </div>
        </section>

        <!-- Alerts Tab -->
        <section class="tab-panel" id="panel-alerts">
          <div class="embed-container" id="embed-alerts">
            <iframe src="/alerts?embed=1" title="Alerts" loading="lazy"></iframe>
          </div>
        </section>

        <!-- Demo Tab -->
        <section class="tab-panel" id="panel-demo">
          <div class="placeholder-content">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <polygon points="5,3 19,12 5,21 5,3"/>
            </svg>
            <h2>Demo Controls</h2>
            <p>Demo scenario execution and controls. Coming in Phase 2.</p>
          </div>
        </section>

        <!-- Infrastructure Tab -->
        <section class="tab-panel" id="panel-infra">
          <div class="embed-container" id="embed-infra">
            <iframe src="/infrastructure?embed=1" title="Infrastructure Status" loading="lazy"></iframe>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    (function() {
      'use strict';

      // Tab navigation
      const tabButtons = document.querySelectorAll('.shell-sidebar-item[data-tab]');
      const tabPanels = document.querySelectorAll('.tab-panel');

      function switchTab(tabId) {
        // Update buttons
        tabButtons.forEach(btn => {
          btn.classList.toggle('active', btn.dataset.tab === tabId);
        });

        // Update panels
        tabPanels.forEach(panel => {
          const panelId = panel.id.replace('panel-', '');
          panel.classList.toggle('active', panelId === tabId);
        });

        // Update URL hash without triggering navigation
        history.replaceState(null, '', `#${tabId}`);
      }

      // Tab click handlers
      tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          switchTab(btn.dataset.tab);
        });
      });

      // Handle initial hash
      function handleInitialHash() {
        const hash = window.location.hash.replace('#', '');
        const validTabs = ['dashboard', 'orders', 'lps', 'alerts', 'demo', 'infra'];
        if (hash && validTabs.includes(hash)) {
          switchTab(hash);
        }
      }

      // Refresh button
      const refreshBtn = document.getElementById('btn-refresh');
      refreshBtn.addEventListener('click', () => {
        const activePanel = document.querySelector('.tab-panel.active');
        const iframe = activePanel.querySelector('iframe');
        if (iframe) {
          iframe.src = iframe.src;
        } else {
          window.location.reload();
        }
      });

      // Status check
      async function checkStatus() {
        const dot = document.getElementById('shell-status-dot');
        const text = document.getElementById('shell-status-text');
        
        try {
          const response = await fetch('/api/health', { timeout: 5000 });
          if (response.ok) {
            dot.className = 'status-dot';
            text.textContent = 'Connected';
          } else {
            dot.className = 'status-dot warning';
            text.textContent = 'Degraded';
          }
        } catch (error) {
          dot.className = 'status-dot error';
          text.textContent = 'Disconnected';
        }
      }

      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (e.altKey && e.key >= '1' && e.key <= '6') {
          e.preventDefault();
          const tabs = ['dashboard', 'orders', 'lps', 'alerts', 'demo', 'infra'];
          const index = parseInt(e.key) - 1;
          if (tabs[index]) {
            switchTab(tabs[index]);
          }
        }
      });

      // Initialize
      handleInitialHash();
      checkStatus();
      setInterval(checkStatus, 30000);

      // Alerts badge button - switch to alerts tab
      document.getElementById('global-alerts-badge-btn').addEventListener('click', () => {
        switchTab('alerts');
      });

      // ========================================================================
      // Infrastructure Status - SSE with Polling Fallback (header connection indicator)
      // ========================================================================
      const connectionShape = document.getElementById('connection-shape');
      const connectionText = document.getElementById('connection-text');
      const connectionLatency = document.getElementById('connection-latency');
      const infraBadge = document.getElementById('infra-badge');
      
      let infraWarnCounter = 0;
      const INFRA_HYSTERESIS = 3;
      const INFRA_POLL_INTERVAL = 10000;
      const SSE_RECONNECT_DELAY = 3000;
      
      let infraEventSource = null;
      let infraSseConnected = false;
      let infraPollTimer = null;
      let sseReconnectTimer = null;

      function updateConnectionIndicator(data) {
        if (!data.success) return;

        let displayStatus = data.status;
        
        // Apply hysteresis for warn state
        if (data.status === 'warn') {
          infraWarnCounter++;
          if (infraWarnCounter < INFRA_HYSTERESIS) {
            displayStatus = 'ok';
          }
        } else if (data.status === 'ok') {
          infraWarnCounter = 0;
        } else if (data.status === 'error') {
          infraWarnCounter = 0;
        }

        // Update connection indicator
        connectionShape.className = 'connection-shape ' + displayStatus;
        connectionText.textContent = displayStatus === 'ok' ? 'OK' : displayStatus === 'warn' ? 'WARN' : 'ERR';
        connectionLatency.textContent = data.data.metrics.avg_latency_ms + 'ms';

        // Update infra badge (show if not ok)
        if (displayStatus !== 'ok') {
          infraBadge.textContent = displayStatus === 'error' ? '!' : 'âš ';
          infraBadge.style.display = 'inline-block';
        } else {
          infraBadge.style.display = 'none';
        }
      }

      function showConnectionError() {
        connectionShape.className = 'connection-shape error';
        connectionText.textContent = 'ERR';
        connectionLatency.textContent = '--';
        infraBadge.textContent = '!';
        infraBadge.style.display = 'inline-block';
      }

      async function fetchInfraStatus() {
        try {
          const response = await fetch('/api/infrastructure/status');
          if (!response.ok) throw new Error('HTTP ' + response.status);
          
          const data = await response.json();
          updateConnectionIndicator(data);

        } catch (err) {
          showConnectionError();
        }
      }

      function startInfraPolling() {
        if (infraPollTimer) clearInterval(infraPollTimer);
        infraPollTimer = setInterval(fetchInfraStatus, INFRA_POLL_INTERVAL);
      }

      function stopInfraPolling() {
        if (infraPollTimer) {
          clearInterval(infraPollTimer);
          infraPollTimer = null;
        }
      }

      function connectInfraSSE() {
        if (infraEventSource) {
          infraEventSource.close();
        }

        try {
          infraEventSource = new EventSource('/api/infrastructure/stream');

          infraEventSource.addEventListener('connected', () => {
            console.log('[Shell SSE] Connected to infrastructure stream');
            infraSseConnected = true;
            stopInfraPolling();
          });

          infraEventSource.addEventListener('infra', (e) => {
            try {
              const data = JSON.parse(e.data);
              updateConnectionIndicator(data);
            } catch (err) {
              console.error('[Shell SSE] Parse error:', err);
            }
          });

          infraEventSource.onerror = () => {
            console.warn('[Shell SSE] Connection error, falling back to polling');
            infraSseConnected = false;
            infraEventSource.close();
            infraEventSource = null;
            
            if (!infraPollTimer) {
              startInfraPolling();
            }
            
            if (sseReconnectTimer) clearTimeout(sseReconnectTimer);
            sseReconnectTimer = setTimeout(() => {
              console.log('[Shell SSE] Attempting reconnect...');
              connectInfraSSE();
            }, SSE_RECONNECT_DELAY);
          };

        } catch (err) {
          console.error('[Shell SSE] Failed to create EventSource:', err);
          startInfraPolling();
        }
      }

      function disconnectInfraSSE() {
        if (sseReconnectTimer) {
          clearTimeout(sseReconnectTimer);
          sseReconnectTimer = null;
        }
        if (infraEventSource) {
          infraEventSource.close();
          infraEventSource = null;
        }
        infraSseConnected = false;
      }

      // Initial: fetch immediately, then connect SSE
      fetchInfraStatus();
      connectInfraSSE();

      // Listen for messages from infrastructure iframe
      window.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'infra-status') {
          // Update from embedded iframe (real-time sync)
          const status = event.data.status;
          connectionShape.className = 'connection-shape ' + status;
          connectionText.textContent = status === 'ok' ? 'OK' : status === 'warn' ? 'WARN' : 'ERR';
          if (event.data.metrics) {
            connectionLatency.textContent = event.data.metrics.avg_latency_ms + 'ms';
          }
        }
      });

      // Expose API for programmatic control
      window.CommandCenterV2 = {
        switchTab,
        refresh: () => refreshBtn.click()
      };
    })();
  </script>

  <!-- Global Context Bus -->
  <script src="/assets/global-context.js"></script>
  <script>
    // Initialize global context after DOM is ready
    if (typeof BO_CTX !== 'undefined') {
      BO_CTX.initShell({
        serverSelectId: 'global-server-select',
        timeWindowId: 'global-time-window',
        alertsBadgeId: 'global-alerts-badge',
        searchTriggerId: 'global-search-trigger',
        systemStatusId: 'global-system-status',
        servers: [
          { id: 'all', name: 'All Servers' },
          { id: 'demo-1', name: 'Demo Server 1' },
          { id: 'demo-2', name: 'Demo Server 2' }
        ],
        defaultServer: 'all',
        defaultTimeWindow: '24h',
        onNavigate: (tabKey) => {
          if (window.CommandCenterV2) {
            window.CommandCenterV2.switchTab(tabKey);
          }
        },
        onServerChange: (serverId) => {
          console.log('[Shell] Server changed:', serverId);
          // Refresh all iframes when server changes
          document.querySelectorAll('.embed-container iframe').forEach(iframe => {
            const url = new URL(iframe.src, window.location.origin);
            url.searchParams.set('server', serverId);
            iframe.src = url.toString();
          });
        },
        onTimeWindowChange: (windowKey, minutes) => {
          console.log('[Shell] Time window changed:', windowKey, minutes);
          BO_CTX.broadcastToIframes('TIME_WINDOW_CHANGE', { window: windowKey, minutes });
        }
      });

      // Fetch initial alert count - single source of truth
      async function fetchAlertCount() {
        try {
          const res = await fetch('/api/alerts');
          const json = await res.json();
          // Handle multiple API response shapes: {data:[...]}, {alerts:[...]}, or [...]
          const alerts = json.data || json.alerts || (Array.isArray(json) ? json : []);
          // Count OPEN/active alerts (API uses uppercase "OPEN")
          const activeCount = alerts.filter(a => 
            a.status === 'OPEN' || a.status === 'active'
          ).length;
          BO_CTX.updateAlertBadge(activeCount);
        } catch (err) {
          // On error, show 0 - don't show fake counts
          BO_CTX.updateAlertBadge(0);
        }
      }

      fetchAlertCount();
      // Poll for alert count updates every 30s
      setInterval(fetchAlertCount, 30000);
    }
  </script>

  <!-- Provenance Footer (shell-level, covers all embedded content) -->
  <script src="/assets/provenance-footer.js"></script>
</body>
</html>

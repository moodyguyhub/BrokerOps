<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BrokerOps ‚Äî Governance Authority</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet" />
  <link href="/styles.css" rel="stylesheet" />
  <style>
    :root {
      --bg: #0f172a;
      --bg-card: #1e293b;
      --bg-hover: #334155;
      --text: #f8fafc;
      --text-muted: #94a3b8;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --success: #22c55e;
      --danger: #ef4444;
      --warning: #f59e0b;
      --border: #334155;
      --purple: #a855f7;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }
    
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    
    /* Header */
    header {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 16px 0;
      margin-bottom: 24px;
    }
    
    header .container {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .logo {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--accent);
    }
    
    .logo span { color: var(--text-muted); font-weight: 400; font-size: 0.9rem; }
    
    nav { display: flex; gap: 8px; }
    
    nav button {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    nav button:hover { background: var(--bg-hover); color: var(--text); }
    nav button.active { background: var(--accent); border-color: var(--accent); color: white; }
    
    /* KPI Cards */
    .kpi-row {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    
    @media (max-width: 900px) {
      .kpi-row { grid-template-columns: repeat(2, 1fr); }
    }
    
    .kpi-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    
    .kpi-card.primary {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.05));
      border-color: var(--success);
    }
    
    .kpi-card.warning {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(245, 158, 11, 0.05));
      border-color: var(--warning);
    }
    
    .kpi-card .label {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--text-muted);
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    
    .kpi-card .value {
      font-size: 2rem;
      font-weight: 700;
    }
    
    .kpi-card.primary .value { color: var(--success); }
    .kpi-card.warning .value { color: var(--warning); }
    .kpi-card .subtext {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }
    
    /* Tooltips */
    .tooltip-trigger {
      position: relative;
      cursor: help;
    }
    
    .tooltip-trigger .tooltip {
      visibility: hidden;
      opacity: 0;
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #1a1a2e;
      color: var(--text);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 400;
      white-space: nowrap;
      z-index: 100;
      margin-bottom: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      border: 1px solid var(--border);
      transition: opacity 0.2s, visibility 0.2s;
    }
    
    .tooltip-trigger .tooltip.wide {
      white-space: normal;
      width: 200px;
      text-align: center;
    }
    
    .tooltip-trigger:hover .tooltip {
      visibility: visible;
      opacity: 1;
    }
    
    .tooltip-trigger .tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: #1a1a2e;
    }
    
    /* Governance Funnel */
    .funnel-widget {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
    }
    
    .funnel-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .funnel-stages {
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
    }
    
    .funnel-stage {
      flex: 1;
      text-align: center;
      position: relative;
      z-index: 1;
    }
    
    .funnel-stage .count {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 4px;
    }
    
    .funnel-stage .stage-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
    }
    
    .funnel-stage.inbound .count { color: var(--accent); }
    .funnel-stage.approved .count { color: var(--success); }
    .funnel-stage.review .count { color: var(--warning); }
    .funnel-stage.blocked .count { color: var(--danger); }
    
    .funnel-arrow {
      color: var(--text-muted);
      font-size: 20px;
      padding: 0 8px;
    }
    
    /* System health indicator */
    .system-health {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid var(--success);
      border-radius: 8px;
      margin-bottom: 24px;
    }
    
    .system-health .pulse {
      width: 10px;
      height: 10px;
      background: var(--success);
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }
    
    /* Cards */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 16px;
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .card-title { font-size: 1.1rem; font-weight: 600; }
    
    /* Tables */
    table { width: 100%; border-collapse: collapse; }
    
    th, td {
      text-align: left;
      padding: 12px;
      border-bottom: 1px solid var(--border);
    }
    
    th { color: var(--text-muted); font-weight: 500; font-size: 12px; text-transform: uppercase; }
    
    tr:hover { background: var(--bg-hover); }
    
    /* Badges */
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .badge-success { background: rgba(34, 197, 94, 0.2); color: var(--success); }
    .badge-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
    .badge-warning { background: rgba(245, 158, 11, 0.2); color: var(--warning); }
    .badge-info { background: rgba(59, 130, 246, 0.2); color: var(--accent); }
    .badge-purple { background: rgba(168, 85, 247, 0.2); color: var(--purple); }
    
    /* Buttons */
    .btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s;
    }
    
    .btn:hover { background: var(--accent-hover); }
    .btn-sm { padding: 4px 10px; font-size: 12px; }
    
    /* Links */
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    
    /* Summary Grid */
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .summary-item {
      background: var(--bg);
      border-radius: 8px;
      padding: 16px;
    }
    
    .summary-item label {
      display: block;
      color: var(--text-muted);
      font-size: 11px;
      text-transform: uppercase;
      margin-bottom: 4px;
    }
    
    .summary-item .value {
      font-size: 1.25rem;
      font-weight: 600;
    }
    
    /* Human Translation Card */
    .translation-card {
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
      border: 1px solid var(--accent);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
    }
    
    .translation-primary {
      font-size: 1.25rem;
      font-weight: 500;
      margin-bottom: 12px;
      line-height: 1.4;
    }
    
    .translation-secondary {
      font-size: 13px;
      color: var(--text-muted);
    }
    
    .translation-secondary code {
      background: var(--bg);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
    }
    
    /* Breach visualization */
    .breach-viz {
      background: var(--bg);
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }
    
    .breach-viz .breach-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .breach-viz .breach-bar {
      height: 24px;
      background: rgba(239, 68, 68, 0.2);
      border-radius: 4px;
      position: relative;
      overflow: hidden;
    }
    
    .breach-viz .breach-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--success), var(--warning), var(--danger));
      border-radius: 4px;
    }
    
    .breach-viz .breach-marker {
      position: absolute;
      top: 0;
      height: 100%;
      width: 3px;
      background: white;
    }
    
    .breach-viz .breach-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 12px;
      color: var(--text-muted);
    }
    
    /* Hash chain visual */
    .hash-chain {
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 12px;
    }
    
    .hash-chain .event {
      display: flex;
      align-items: center;
      padding: 12px;
      border-left: 3px solid var(--border);
      margin-left: 12px;
      position: relative;
    }
    
    .hash-chain .event::before {
      content: '';
      position: absolute;
      left: -8px;
      width: 12px;
      height: 12px;
      background: var(--bg-card);
      border: 2px solid var(--accent);
      border-radius: 50%;
    }
    
    .hash-chain .event:hover { background: var(--bg-hover); }
    
    .hash-chain .event-type { min-width: 180px; color: var(--accent); font-weight: 500; }
    .hash-chain .hash { color: var(--text-muted); }
    
    .hash-chain-expanded {
      background: var(--bg);
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }
    
    .hash-chain-expanded .chain-node {
      display: flex;
      align-items: center;
      padding: 12px;
      margin-bottom: 8px;
      background: var(--bg-card);
      border-radius: 6px;
      border-left: 3px solid var(--accent);
    }
    
    .hash-chain-expanded .chain-connector {
      text-align: center;
      color: var(--text-muted);
      padding: 4px;
      font-size: 18px;
    }
    
    /* Integrity banner */
    .integrity-banner {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 24px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .integrity-banner:hover { transform: translateY(-2px); }
    
    .integrity-banner.verified { background: rgba(34, 197, 94, 0.15); border: 1px solid var(--success); }
    .integrity-banner.failed { background: rgba(239, 68, 68, 0.15); border: 1px solid var(--danger); }
    
    .integrity-banner .icon { font-size: 24px; }
    .integrity-banner .click-hint { font-size: 12px; color: var(--text-muted); margin-left: auto; }
    
    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }
    
    /* Empty state */
    .empty {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }
    
    .empty h3 { color: var(--text); margin-bottom: 8px; }
    
    /* Back button */
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--text-muted);
      margin-bottom: 16px;
    }
    
    .back-link:hover { color: var(--text); text-decoration: none; }
    
    /* JSON viewer - collapsed by default */
    .json-section { margin-top: 16px; }
    .json-toggle {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      width: 100%;
      text-align: left;
    }
    .json-toggle:hover { background: var(--bg-hover); color: var(--text); }
    .json-viewer {
      background: var(--bg);
      border-radius: 8px;
      padding: 16px;
      overflow-x: auto;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 12px;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 8px;
      display: none;
    }
    .json-viewer.expanded { display: block; }
    
    /* Playground */
    .playground-input {
      width: 100%;
      min-height: 150px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      color: var(--text);
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 13px;
      resize: vertical;
    }
    .playground-input:focus { outline: none; border-color: var(--accent); }
    
    .playground-result {
      background: var(--bg);
      border-radius: 8px;
      padding: 20px;
      margin-top: 16px;
    }
    
    .verdict {
      font-size: 2.5rem;
      font-weight: 700;
      text-align: center;
      margin-bottom: 16px;
    }
    .verdict.allow { color: var(--success); }
    .verdict.block { color: var(--danger); }
  </style>
</head>
<body class="h-full bg-slate-50 text-slate-900 font-sans">
  <div class="flex min-h-screen">
    <aside class="w-64 bg-slate-900 text-slate-100 flex flex-col">
      <div class="px-6 py-5 border-b border-slate-800">
        <div class="text-lg font-semibold tracking-tight">BrokerOps</div>
        <div class="text-xs text-slate-400">Governance Authority</div>
      </div>
      <nav class="flex-1 px-3 py-4 space-y-1">
        <button class="nav-btn w-full text-left text-sm px-3 py-2 rounded-lg text-slate-300 hover:bg-slate-800 hover:text-white" onclick="navigate('evaluations')" id="nav-evaluations">Evaluations</button>
        <button class="nav-btn w-full text-left text-sm px-3 py-2 rounded-lg text-slate-300 hover:bg-slate-800 hover:text-white" onclick="navigate('playground')" id="nav-playground">Simulation Lab</button>
        <button class="nav-btn w-full text-left text-sm px-3 py-2 rounded-lg text-slate-300 hover:bg-slate-800 hover:text-white" onclick="navigate('webhooks')" id="nav-webhooks">Integrations</button>
        <a href="/truvesta" class="nav-btn w-full text-left text-sm px-3 py-2 rounded-lg text-cyan-400 hover:bg-slate-800 hover:text-cyan-300 flex items-center gap-2 mt-4 border border-cyan-500/30">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/></svg>
          Truvesta Demo
        </a>
      </nav>
      <div class="px-6 py-4 border-t border-slate-800 text-xs text-slate-400">
        Guardrail Set: <span class="font-mono text-slate-300">policy.v0.2</span>
      </div>
    </aside>

    <main class="flex-1 p-6" id="app">
      <div class="text-sm text-slate-500">Loading...</div>
    </main>
  </div>

  <script src="/PolicyTranslator.js"></script>
  <script>
    // Manual verification checklist (PH1-023):
    // - All: server selector shows mixed servers in LP timelines.
    // - Server 1/2: timelines filtered by server_id.
    // - Policy scope persists across reload.
    // - Exposure card labeled DEMO / Derived.
    // - Timeline detail shows server_id/server_name.

    // =========================================================================
    // State
    // =========================================================================
    let currentPage = 'evaluations';
    let currentTraceId = null;
    let currentLpTraceId = null;
    let showHashChainExpanded = false;
    let showRawJson = false;

    const SERVER_OPTIONS = [
      { label: 'All', value: 'all' },
      { label: 'Server 1', value: 'srv-1' },
      { label: 'Server 2', value: 'srv-2' }
    ];

    const POLICY_SCOPE_OPTIONS = [
      { label: 'All', value: 'all' },
      { label: 'Server 1', value: 'srv-1' },
      { label: 'Server 2', value: 'srv-2' }
    ];

    function getQueryParam(key) {
      return new URLSearchParams(window.location.search).get(key);
    }

    function setQueryParam(key, value) {
      const params = new URLSearchParams(window.location.search);
      if (!value || value === 'all') {
        params.delete(key);
      } else {
        params.set(key, value);
      }
      const newUrl = `${window.location.pathname}?${params.toString()}`;
      window.history.replaceState({}, '', newUrl);
    }

    function getInitialServerSelection() {
      const fromQuery = getQueryParam('server_id');
      const fromStorage = localStorage.getItem('demo.server_id');
      if (fromQuery) {
        localStorage.setItem('demo.server_id', fromQuery);
        return fromQuery;
      }
      if (fromStorage) {
        setQueryParam('server_id', fromStorage);
        return fromStorage;
      }
      return 'all';
    }

    function getInitialPolicyScope() {
      const fromQuery = getQueryParam('policy_scope');
      const fromStorage = localStorage.getItem('demo.policy_scope');
      if (fromQuery) {
        localStorage.setItem('demo.policy_scope', fromQuery);
        return fromQuery;
      }
      if (fromStorage) {
        setQueryParam('policy_scope', fromStorage);
        return fromStorage;
      }
      return 'all';
    }

    let selectedServerId = getInitialServerSelection();
    let policyScope = getInitialPolicyScope();

    // =========================================================================
    // Navigation
    // =========================================================================
    function navigate(page, params = {}) {
      currentPage = page;
      currentTraceId = params.traceId || null;
      currentLpTraceId = params.lpTraceId || null;
      showHashChainExpanded = false;
      showRawJson = false;
      
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('bg-slate-800', 'text-white');
        btn.classList.add('text-slate-300');
      });
      const navBtn = document.getElementById(`nav-${page}`);
      if (navBtn) {
        navBtn.classList.add('bg-slate-800', 'text-white');
        navBtn.classList.remove('text-slate-300');
      }
      
      render();
    }

    function updateServerSelection(value) {
      selectedServerId = value;
      localStorage.setItem('demo.server_id', value);
      setQueryParam('server_id', value);
      render();
    }

    function updatePolicyScope(value) {
      policyScope = value;
      localStorage.setItem('demo.policy_scope', value);
      setQueryParam('policy_scope', value);
      render();
    }

    // =========================================================================
    // API calls
    // =========================================================================
    async function fetchTraces() {
      const resp = await fetch('/api/traces/recent?limit=100');
      return resp.json();
    }

    async function fetchLpTimelines(serverId = 'all') {
      const params = new URLSearchParams({ limit: '100' });
      if (serverId && serverId !== 'all') {
        params.set('server_id', serverId);
      }
      const resp = await fetch(`/api/lp-timelines/recent?${params.toString()}`);
      return resp.json();
    }

    async function fetchLpTimeline(traceId) {
      const resp = await fetch(`/api/lp-timeline/${traceId}`);
      return resp.json();
    }

    async function fetchBundle(traceId) {
      const resp = await fetch(`/api/trace/${traceId}/bundle`);
      return resp.json();
    }

    async function fetchEconomics(traceId) {
      const resp = await fetch(`/api/economics/trace/${traceId}`);
      return resp.json();
    }
    
    async function fetchEconomicsSummary() {
      const resp = await fetch('/api/economics/summary');
      return resp.json();
    }
    
    // P1: Fetch saved exposure KPI
    async function fetchSavedExposure(hours = 24) {
      const resp = await fetch(`/api/economics/saved-exposure?hours=${hours}`);
      return resp.json();
    }
    
    // P1-R2: Fetch coverage statistics
    async function fetchCoverageStats(hours = 24) {
      const resp = await fetch(`/api/economics/coverage?hours=${hours}`);
      return resp.json();
    }
    
    async function fetchPendingOverrides() {
      try {
        const resp = await fetch('/api/overrides/pending');
        return resp.json();
      } catch {
        return { count: 0 };
      }
    }

    async function fetchWebhooks() {
      const resp = await fetch('/api/webhooks');
      return resp.json();
    }

    async function fetchDeliveries() {
      const resp = await fetch('/api/webhooks/deliveries?limit=50');
      return resp.json();
    }
    
    // Dry-run policy evaluation (no persistence)
    async function testPolicy(order) {
      const resp = await fetch('/api/dry-run', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(order)
      });
      return resp.json();
    }

    // =========================================================================
    // Render functions
    // =========================================================================
    async function render() {
      const app = document.getElementById('app');
      app.innerHTML = '<div class="text-sm text-slate-500">Loading...</div>';

      try {
        if (currentPage === 'evaluations' && currentTraceId) {
          await renderBundle();
        } else if (currentPage === 'evaluations' && currentLpTraceId) {
          await renderLpTimelineDetail();
        } else if (currentPage === 'evaluations') {
          await renderEvaluations();
        } else if (currentPage === 'playground') {
          await renderPlayground();
        } else if (currentPage === 'webhooks') {
          await renderWebhooks();
        }
      } catch (err) {
        app.innerHTML = `<div class="rounded-lg bg-white p-4 shadow-sm ring-1 ring-slate-200">
          <p class="text-sm text-red-600">Error: ${err.message}</p>
        </div>`;
      }
    }

    async function renderEvaluations() {
      const [data, econSummary, savedExposureData, pendingOverrides, coverageData, lpTimelineData] = await Promise.all([
        fetchTraces(),
        fetchEconomicsSummary().catch(() => ({})),
        fetchSavedExposure(24).catch(() => ({ saved_exposure: 0, change_percent: 0, blocked_count: 0 })),
        fetchPendingOverrides().catch(() => ({ count: 0 })),
        fetchCoverageStats(24).catch(() => ({ total_decisions: 0, decisions_with_price: 0, coverage_percent: 0 })),
        fetchLpTimelines(selectedServerId).catch(() => ({ timelines: [], count: 0 }))
      ]);

      const app = document.getElementById('app');
      const traces = data.traces || [];
      const lpTimelines = lpTimelineData.timelines || [];

      const now = Date.now();
      const last24h = traces.filter(t => {
        const ts = new Date(t.startedAt).getTime();
        return (now - ts) < 24 * 60 * 60 * 1000;
      });

      const totalEvals24h = last24h.length;
      const blockedTraces = last24h.filter(t => t.outcome === 'BLOCKED');
      const authorizedTraces = last24h.filter(t => t.outcome === 'AUTHORIZED' || t.outcome === 'ACCEPTED');
      const overrideTraces = last24h.filter(t => t.hasOverride);
      // P1: Use saved exposure from dedicated endpoint
      const savedExposure = savedExposureData.saved_exposure || 0;
      const savedExposureChange = savedExposureData.change_percent || 0;
      const blockedCount = savedExposureData.blocked_count || blockedTraces.length;
      const pendingCount = pendingOverrides.count || 0;
      // P1-R2: Coverage stats
      const coveragePct = coverageData.coverage_percent || 0;
      const priceDecisions = coverageData.decisions_with_price || 0;
      const totalDecisions = coverageData.total_decisions || 0;
      const usdPct = coverageData.usd_percent || 0;

      const inbound = totalEvals24h;
      const autoAuthorized = authorizedTraces.length - overrideTraces.length;
      const manualReview = overrideTraces.length;
      const blocked = blockedTraces.length - overrideTraces.length;

      // Format trend indicator
      const savedTrendArrow = savedExposureChange >= 0 ? '‚Üë' : '‚Üì';
      const savedTrendColor = savedExposureChange >= 0 ? 'text-emerald-600' : 'text-red-600';
      // Coverage quality indicator
      const coverageQuality = coveragePct >= 90 ? 'emerald' : coveragePct >= 70 ? 'amber' : 'red';

      const serverLabel = (id) => {
        if (id === 'srv-1') return 'Server 1 (srv-1)';
        if (id === 'srv-2') return 'Server 2 (srv-2)';
        return 'All Servers';
      };

      const totalOrderCount = lpTimelines.length;
      const totalQty = lpTimelines.reduce((acc, t) => acc + (Number(t.qty) || 0), 0);
      const qtyAvailable = totalQty > 0;
      const perServerCounts = lpTimelines.reduce((acc, t) => {
        const key = t.server_id || 'unknown';
        acc[key] = (acc[key] || 0) + 1;
        return acc;
      }, {});

      app.innerHTML = `
        <div class="mb-6 rounded-lg bg-emerald-50 border border-emerald-200 px-4 py-3 flex items-center gap-3">
          <span class="h-2 w-2 rounded-full bg-emerald-500 animate-pulse"></span>
          <span class="text-sm font-medium text-emerald-900">System Healthy</span>
          <span class="text-xs text-emerald-700">Guardrails active</span>
        </div>

        <div class="rounded-lg bg-white shadow-sm ring-1 ring-slate-200 mb-6">
          <div class="flex flex-wrap items-center gap-4 px-4 py-3">
            <div>
              <div class="text-xs uppercase text-slate-500">Server View</div>
              <select class="mt-1 rounded-md border border-slate-300 bg-white px-3 py-2 text-sm" id="server-select">
                ${SERVER_OPTIONS.map(opt => `
                  <option value="${opt.value}" ${selectedServerId === opt.value ? 'selected' : ''}>${opt.label}</option>
                `).join('')}
              </select>
              <div class="mt-1 text-xs text-slate-500">Showing: ${serverLabel(selectedServerId)}</div>
            </div>
            <div>
              <div class="text-xs uppercase text-slate-500">Policy Scope</div>
              <select class="mt-1 rounded-md border border-slate-300 bg-white px-3 py-2 text-sm" id="policy-scope-select">
                ${POLICY_SCOPE_OPTIONS.map(opt => `
                  <option value="${opt.value}" ${policyScope === opt.value ? 'selected' : ''}>${opt.label}</option>
                `).join('')}
              </select>
              <div class="mt-1 text-xs text-amber-600">Demo only ‚Äî not enforced in authorization yet</div>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-4 mb-6">
          <div class="rounded-lg bg-white p-4 shadow-sm ring-1 ring-slate-200">
            <div class="text-xs uppercase text-slate-500">Evaluations (24h)</div>
            <div class="mt-2 text-2xl font-semibold font-mono text-slate-900">${totalEvals24h}</div>
            <div class="mt-1 text-xs text-slate-500">Total guardrail checks</div>
          </div>
          <div class="rounded-lg bg-white p-4 shadow-sm ring-1 ring-emerald-200 bg-emerald-50">
            <div class="text-xs uppercase text-emerald-700">Saved Exposure (24h)</div>
            <div class="mt-2 text-2xl font-semibold font-mono text-emerald-700">$${savedExposure.toLocaleString()}</div>
            <div class="mt-1 flex items-center gap-2 text-xs ${savedTrendColor}">
              <span class="font-mono">${savedTrendArrow} ${Math.abs(savedExposureChange).toFixed(1)}%</span>
              <span class="text-emerald-600">vs prev 24h</span>
              <span class="text-slate-500">(${blockedCount} blocked)</span>
            </div>
          </div>
          <div class="rounded-lg bg-white p-4 shadow-sm ring-1 ring-${coverageQuality}-200 bg-${coverageQuality}-50">
            <div class="text-xs uppercase text-${coverageQuality}-700">Price Coverage</div>
            <div class="mt-2 text-2xl font-semibold font-mono text-${coverageQuality}-700">${coveragePct.toFixed(1)}%</div>
            <div class="mt-1 text-xs text-${coverageQuality}-600">${priceDecisions}/${totalDecisions} with prices ‚Ä¢ ${usdPct.toFixed(0)}% USD</div>
          </div>
          <div class="rounded-lg bg-white p-4 shadow-sm ring-1 ring-slate-200">
            <div class="text-xs uppercase text-slate-500">Pending Overrides</div>
            <div class="mt-2 text-2xl font-semibold font-mono text-slate-900">${pendingCount}</div>
            <div class="mt-1 text-xs text-slate-500">Awaiting dual-control</div>
          </div>
          <div class="rounded-lg bg-white p-4 shadow-sm ring-1 ring-slate-200">
            <div class="text-xs uppercase text-slate-500">Override Rate</div>
            <div class="mt-2 text-2xl font-semibold font-mono text-slate-900">${totalEvals24h > 0 ? ((overrideTraces.length / totalEvals24h) * 100).toFixed(1) : 0}%</div>
            <div class="mt-1 text-xs text-slate-500">Manual interventions</div>
          </div>
        </div>

        <div class="rounded-lg bg-white shadow-sm ring-1 ring-slate-200 mb-6">
          <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
            <h2 class="text-sm font-semibold text-slate-900">Total exposure across servers (DEMO / Derived)</h2>
            <span class="text-xs text-slate-500">From lp.order timelines</span>
          </div>
          <div class="p-4 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="rounded-md bg-slate-50 p-3">
              <div class="text-xs uppercase text-slate-500">Total order flow (count)</div>
              <div class="mt-2 text-xl font-semibold font-mono text-slate-900">${totalOrderCount}</div>
            </div>
            <div class="rounded-md bg-slate-50 p-3">
              <div class="text-xs uppercase text-slate-500">Total qty (derived)</div>
              <div class="mt-2 text-xl font-semibold font-mono text-slate-900">${qtyAvailable ? totalQty.toLocaleString() : 'N/A'}</div>
              <div class="text-xs text-slate-500">${qtyAvailable ? 'Sum of recent order qty' : 'Qty not available; showing count only'}</div>
            </div>
            <div class="rounded-md bg-slate-50 p-3">
              <div class="text-xs uppercase text-slate-500">By server</div>
              <div class="mt-2 text-sm text-slate-700">
                <div>Server 1: <span class="font-mono">${perServerCounts['srv-1'] || 0}</span></div>
                <div>Server 2: <span class="font-mono">${perServerCounts['srv-2'] || 0}</span></div>
                <div>Unknown: <span class="font-mono">${perServerCounts['unknown'] || 0}</span></div>
              </div>
            </div>
          </div>
        </div>

        <div class="rounded-lg bg-white shadow-sm ring-1 ring-slate-200 mb-6">
          <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
            <div class="text-sm font-semibold text-slate-900">Governance Funnel (24h)</div>
            <div class="text-xs text-slate-500">Stages are mutually exclusive</div>
          </div>
          <div class="p-4">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div class="rounded-md bg-slate-50 p-3 text-center">
                <div class="text-lg font-semibold font-mono text-slate-900">${inbound}</div>
                <div class="text-xs uppercase text-slate-500">Inbound</div>
              </div>
              <div class="rounded-md bg-emerald-50 p-3 text-center">
                <div class="text-lg font-semibold font-mono text-emerald-700">${autoAuthorized}</div>
                <div class="text-xs uppercase text-emerald-700">Authorized</div>
              </div>
              <div class="rounded-md bg-amber-50 p-3 text-center">
                <div class="text-lg font-semibold font-mono text-amber-700">${manualReview}</div>
                <div class="text-xs uppercase text-amber-700">Pending Review</div>
              </div>
              <div class="rounded-md bg-red-50 p-3 text-center">
                <div class="text-lg font-semibold font-mono text-red-700">${Math.max(0, blocked)}</div>
                <div class="text-xs uppercase text-red-700">Policy-Blocked</div>
              </div>
            </div>
          </div>
        </div>

        ${traces.length === 0 ? `
          <div class="rounded-lg bg-white p-6 shadow-sm ring-1 ring-slate-200 text-center">
            <div class="text-lg font-semibold text-slate-900">No evaluations yet</div>
            <p class="mt-2 text-sm text-slate-500">Submit an order to see evaluations appear here.</p>
            <p class="mt-3 text-sm text-slate-500">Or use the <button class="text-indigo-600 hover:text-indigo-700" onclick="navigate('playground')">Simulation Lab</button>.</p>
          </div>
        ` : `
          <div class="rounded-lg bg-white shadow-sm ring-1 ring-slate-200">
            <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
              <h2 class="text-sm font-semibold text-slate-900">Recent Evaluations</h2>
              <span class="text-xs text-slate-500">${data.count} records</span>
            </div>
            <ul role="list" class="divide-y divide-slate-200">
              ${traces.slice(0, 50).map(t => {
                const verdictBadge = (t.outcome === 'AUTHORIZED' || t.outcome === 'ACCEPTED')
                  ? `<span class=\"inline-flex items-center gap-2 rounded-full bg-emerald-50 px-2.5 py-1 text-xs font-semibold text-emerald-700\"><span class=\\\"h-2 w-2 rounded-full bg-emerald-500\\\"></span>Authorized</span>`
                  : t.outcome === 'BLOCKED'
                    ? `<span class=\"inline-flex items-center gap-2 rounded-full bg-red-50 px-2.5 py-1 text-xs font-semibold text-red-700\"><span class=\\\"h-2 w-2 rounded-full bg-red-500\\\"></span>Policy-Blocked</span>`
                    : `<span class=\"inline-flex items-center gap-2 rounded-full bg-amber-50 px-2.5 py-1 text-xs font-semibold text-amber-700\"><span class=\\\"h-2 w-2 rounded-full bg-amber-500 animate-pulse\\\"></span>Pending Review</span>`;

                return `
                  <li class="py-2.5 px-4">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
                      <div>
                        <div class="text-sm font-semibold text-slate-900">
                          Evaluation <span class="font-mono text-indigo-600">${t.traceId.slice(0, 8)}...</span>
                        </div>
                        <div class="mt-1 text-xs text-slate-500">
                          ${PolicyTranslator.humanizeReason(t.reasonCode)} ${t.ruleId ? `<span class=\\\"font-mono\\\">(${t.ruleId})</span>` : ''}
                        </div>
                      </div>
                      <div class="flex flex-wrap items-center gap-3">
                        ${verdictBadge}
                        <div class="text-xs text-slate-500">Events: <span class="font-mono">${t.eventCount}</span></div>
                        <div class="text-xs text-slate-500 font-mono">${formatTime(t.startedAt)}</div>
                        <button class="inline-flex items-center rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 hover:bg-slate-50" onclick="navigate('evaluations', {traceId: '${t.traceId}'})">View Record</button>
                      </div>
                    </div>
                  </li>
                `;
              }).join('')}
            </ul>
          </div>
        `}

        <div class="rounded-lg bg-white shadow-sm ring-1 ring-slate-200 mt-6">
          <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
            <h2 class="text-sm font-semibold text-slate-900">LP Order Timelines</h2>
            <span class="text-xs text-slate-500">${lpTimelineData.count || lpTimelines.length} records</span>
          </div>
          ${lpTimelines.length === 0 ? `
            <div class="px-4 py-6 text-sm text-slate-500">No LP timelines yet for this server filter.</div>
          ` : `
            <ul role="list" class="divide-y divide-slate-200">
              ${lpTimelines.slice(0, 50).map(t => `
                <li class="py-2.5 px-4">
                  <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
                    <div>
                      <div class="text-sm font-semibold text-slate-900">
                        LP Timeline <span class="font-mono text-indigo-600">${(t.trace_id || '').slice(0, 8)}...</span>
                      </div>
                      <div class="mt-1 text-xs text-slate-500">${t.server_name || 'Unknown'} ‚Ä¢ <span class="font-mono">${t.server_id || 'unknown'}</span></div>
                    </div>
                    <div class="flex flex-wrap items-center gap-3">
                      <div class="text-xs text-slate-500">Status: <span class="font-mono">${t.current_status || t.last_status || 'UNKNOWN'}</span></div>
                      <div class="text-xs text-slate-500">Symbol: <span class="font-mono">${t.symbol || '-'}</span></div>
                      <div class="text-xs text-slate-500">Qty: <span class="font-mono">${t.qty || '-'}</span></div>
                      <div class="text-xs text-slate-500 font-mono">${formatTime(t.started_at || t.startedAt || t.last_event_at)}</div>
                      <button class="inline-flex items-center rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 hover:bg-slate-50" onclick="navigate('evaluations', {lpTraceId: '${t.trace_id}'})">View Timeline</button>
                    </div>
                  </div>
                </li>
              `).join('')}
            </ul>
          `}
        </div>

        <div class="mt-6 text-xs text-slate-500">
          Data provenance: Demo data from lp-simulator; proof-carrying server identity; real multi-server management is Phase 2.
        </div>
      `;

      const serverSelect = document.getElementById('server-select');
      if (serverSelect) {
        serverSelect.addEventListener('change', (e) => updateServerSelection(e.target.value));
      }

      const policySelect = document.getElementById('policy-scope-select');
      if (policySelect) {
        policySelect.addEventListener('change', (e) => updatePolicyScope(e.target.value));
      }
    }

    async function renderLpTimelineDetail() {
      const timeline = await fetchLpTimeline(currentLpTraceId);
      const app = document.getElementById('app');

      if (timeline.error) {
        app.innerHTML = `
          <button class="text-sm text-slate-500 hover:text-slate-700" onclick="navigate('evaluations')">‚Üê Back to Evaluations</button>
          <div class="mt-4 rounded-lg border border-red-200 bg-red-50 p-4">
            <strong class="text-red-800">Error</strong>
            <p class="text-sm text-red-700">${timeline.message || timeline.error}</p>
          </div>
        `;
        return;
      }

      const events = timeline.events || [];
      const head = events[0] || {};
      const serverName = head.source?.server_name || 'Unknown';
      const serverId = head.source?.server_id || 'unknown';

      app.innerHTML = `
        <button class="text-sm text-slate-500 hover:text-slate-700" onclick="navigate('evaluations')">‚Üê Back to Evaluations</button>

        <div class="mt-4 rounded-lg bg-white shadow-sm ring-1 ring-slate-200 p-4">
          <div class="text-sm font-semibold text-slate-900">LP Timeline Detail</div>
          <div class="mt-1 text-xs text-slate-500">Server: ${serverName} ‚Ä¢ <span class="font-mono">${serverId}</span></div>
          <div class="mt-1 text-xs text-slate-500">Trace: <span class="font-mono">${timeline.trace_id}</span></div>
          <div class="mt-1 text-xs text-slate-500">Status: <span class="font-mono">${timeline.current_status}</span></div>
        </div>

        <div class="mt-4 rounded-lg bg-white shadow-sm ring-1 ring-slate-200">
          <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
            <h2 class="text-sm font-semibold text-slate-900">Events</h2>
            <span class="text-xs text-slate-500">${events.length} events</span>
          </div>
          <ul role="list" class="divide-y divide-slate-200">
            ${events.map(e => `
              <li class="py-2.5 px-4">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-3">
                  <div>
                    <div class="text-sm font-semibold text-slate-900">${e.event_type}</div>
                    <div class="mt-1 text-xs text-slate-500">${e.source?.server_name || 'Unknown'} ‚Ä¢ <span class="font-mono">${e.source?.server_id || 'unknown'}</span></div>
                  </div>
                  <div class="flex flex-wrap items-center gap-3">
                    <div class="text-xs text-slate-500">Status: <span class="font-mono">${e.normalization?.status || 'UNKNOWN'}</span></div>
                    <div class="text-xs text-slate-500">Symbol: <span class="font-mono">${e.payload?.symbol || '-'}</span></div>
                    <div class="text-xs text-slate-500">Qty: <span class="font-mono">${e.payload?.qty || '-'}</span></div>
                    <div class="text-xs text-slate-500 font-mono">${formatTime(e.occurred_at)}</div>
                  </div>
                </div>
              </li>
            `).join('')}
          </ul>
        </div>

        <div class="mt-6 text-xs text-slate-500">
          Data provenance: Demo data from lp-simulator; proof-carrying server identity; real multi-server management is Phase 2.
        </div>
      `;
    }

    async function renderBundle() {
      const [bundle, economics] = await Promise.all([
        fetchBundle(currentTraceId),
        fetchEconomics(currentTraceId)
      ]);
      
      const app = document.getElementById('app');
      
      if (bundle.error) {
        const isIntegrityFailure = bundle.error === 'AUDIT_CHAIN_INTEGRITY_FAILURE';
        app.innerHTML = `
          <button class="text-sm text-slate-500 hover:text-slate-700" onclick="navigate('evaluations')">‚Üê Back to Evaluations</button>
          <div class="mt-4 rounded-lg border border-red-200 bg-red-50 p-4">
            <strong class="text-red-800">${isIntegrityFailure ? 'Integrity Failure' : 'Error'}</strong>
            <p class="text-sm text-red-700">${bundle.message || bundle.error}</p>
          </div>
        `;
        return;
      }

      const s = bundle.summary;
      const econ = economics.summary || {};
      
      // Get human translation
      const translation = PolicyTranslator.translate(s);
      const breachData = PolicyTranslator.calculateBreach(s);

      app.innerHTML = `
        <button class="text-sm text-slate-500 hover:text-slate-700" onclick="navigate('evaluations')">‚Üê Back to Evaluations</button>

        <div class="mt-4 rounded-lg ${bundle.integrityVerified ? 'border-emerald-200 bg-emerald-50' : 'border-red-200 bg-red-50'} p-4 flex items-center gap-3 cursor-pointer" onclick="toggleHashChain()">
          <span class="text-xl">${bundle.integrityVerified ? 'üîí' : '‚ö†Ô∏è'}</span>
          <div>
            <div class="text-sm font-semibold ${bundle.integrityVerified ? 'text-emerald-900' : 'text-red-900'}">${bundle.integrityVerified ? 'Integrity Verified' : 'Integrity Check Failed'}</div>
            <div class="text-xs ${bundle.integrityVerified ? 'text-emerald-700' : 'text-red-700'}">Cryptographic hash chain is ${bundle.integrityVerified ? 'intact and tamper-evident' : 'potentially compromised'}</div>
          </div>
          <div class="ml-auto text-xs text-slate-500">Click to ${showHashChainExpanded ? 'hide' : 'view'} proof ‚Üí</div>
        </div>

        ${showHashChainExpanded ? renderHashChainProof(bundle.hashChain) : ''}

        <div class="mt-6 rounded-lg bg-white p-5 shadow-sm ring-1 ring-slate-200">
          <div class="text-lg font-semibold text-slate-900">${translation.primary}</div>
          <div class="mt-2 text-xs text-slate-500">Rule: <span class="font-mono">${s.ruleId || 'none'}</span> ‚Ä¢ Guardrail Set: <span class="font-mono">${s.policyVersion}</span></div>
        </div>

        <div class="mt-6 rounded-lg bg-white shadow-sm ring-1 ring-slate-200">
          <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
            <h2 class="text-sm font-semibold text-slate-900">Decision Record</h2>
            <span class="text-xs font-mono text-slate-500">${currentTraceId}</span>
          </div>
          <dl class="divide-y divide-slate-100">
            <div class="grid grid-cols-3 gap-4 px-4 py-2.5 even:bg-slate-50">
              <dt class="text-xs uppercase text-slate-500">Verdict</dt>
              <dd class="col-span-2 text-sm">
                ${s.outcome === 'AUTHORIZED' || s.outcome === 'ACCEPTED'
                  ? '<span class="inline-flex items-center gap-2 rounded-full bg-emerald-50 px-2.5 py-1 text-xs font-semibold text-emerald-700"><span class="h-2 w-2 rounded-full bg-emerald-500"></span>Authorized</span>'
                  : '<span class="inline-flex items-center gap-2 rounded-full bg-red-50 px-2.5 py-1 text-xs font-semibold text-red-700"><span class="h-2 w-2 rounded-full bg-red-500"></span>Blocked</span>'}
              </dd>
            </div>
            <div class="grid grid-cols-3 gap-4 px-4 py-2.5 even:bg-slate-50">
              <dt class="text-xs uppercase text-slate-500">Final Decision</dt>
              <dd class="col-span-2 text-sm">${s.decision === 'ALLOW' ? 'Allowed' : 'Denied'}</dd>
            </div>
            <div class="grid grid-cols-3 gap-4 px-4 py-2.5 even:bg-slate-50">
              <dt class="text-xs uppercase text-slate-500">Guardrail Set</dt>
              <dd class="col-span-2 text-sm font-mono">${s.policyVersion}</dd>
            </div>
            <div class="grid grid-cols-3 gap-4 px-4 py-2.5 even:bg-slate-50">
              <dt class="text-xs uppercase text-slate-500">Rule Triggered</dt>
              <dd class="col-span-2 text-sm font-mono">${s.ruleId || 'None'}</dd>
            </div>
            <div class="grid grid-cols-3 gap-4 px-4 py-2.5 even:bg-slate-50">
              <dt class="text-xs uppercase text-slate-500">Intervention</dt>
              <dd class="col-span-2 text-sm">
                ${s.hasOverride
                  ? `<span class="inline-flex items-center gap-2 rounded-full bg-indigo-50 px-2.5 py-1 text-xs font-semibold text-indigo-700"><span class="h-2 w-2 rounded-full bg-indigo-500"></span>Override</span> <span class="text-xs text-slate-500">by ${s.overrideBy}</span>`
                  : '<span class="text-xs text-slate-500">None</span>'}
              </dd>
            </div>
          </dl>
          ${breachData ? renderBreachVisualization(breachData, s) : ''}
        </div>

        ${renderSnapshotEconomics(s, econ)}

        ${s.order ? `
        <div class="mt-6 rounded-lg bg-white shadow-sm ring-1 ring-slate-200">
          <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
            <h2 class="text-sm font-semibold text-slate-900">Order Details</h2>
          </div>
          <dl class="divide-y divide-slate-100">
            <div class="grid grid-cols-3 gap-4 px-4 py-2.5 even:bg-slate-50">
              <dt class="text-xs uppercase text-slate-500">Client Order ID</dt>
              <dd class="col-span-2 text-sm font-mono">${s.order.clientOrderId}</dd>
            </div>
            <div class="grid grid-cols-3 gap-4 px-4 py-2.5 even:bg-slate-50">
              <dt class="text-xs uppercase text-slate-500">Symbol</dt>
              <dd class="col-span-2 text-sm font-mono">${s.order.symbol}</dd>
            </div>
            <div class="grid grid-cols-3 gap-4 px-4 py-2.5 even:bg-slate-50">
              <dt class="text-xs uppercase text-slate-500">Side</dt>
              <dd class="col-span-2 text-sm">
                <span class="inline-flex items-center gap-2 rounded-full ${s.order.side === 'BUY' ? 'bg-emerald-50 text-emerald-700' : 'bg-red-50 text-red-700'} px-2.5 py-1 text-xs font-semibold">
                  <span class="h-2 w-2 rounded-full ${s.order.side === 'BUY' ? 'bg-emerald-500' : 'bg-red-500'}"></span>${s.order.side}
                </span>
              </dd>
            </div>
            <div class="grid grid-cols-3 gap-4 px-4 py-2.5 even:bg-slate-50">
              <dt class="text-xs uppercase text-slate-500">Quantity</dt>
              <dd class="col-span-2 text-sm font-mono">${s.order.qty?.toLocaleString()}</dd>
            </div>
            ${s.order.price ? `
            <div class="grid grid-cols-3 gap-4 px-4 py-2.5 even:bg-slate-50">
              <dt class="text-xs uppercase text-slate-500">Price</dt>
              <dd class="col-span-2 text-sm font-mono">$${s.order.price?.toFixed(2)}</dd>
            </div>
            <div class="grid grid-cols-3 gap-4 px-4 py-2.5 even:bg-slate-50">
              <dt class="text-xs uppercase text-slate-500">Notional</dt>
              <dd class="col-span-2 text-sm font-mono">$${(s.order.qty * s.order.price).toLocaleString()}</dd>
            </div>
            ` : ''}
          </dl>
        </div>
        ` : ''}

        <div class="mt-6 rounded-lg bg-white shadow-sm ring-1 ring-slate-200">
          <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
            <h2 class="text-sm font-semibold text-slate-900">Audit Trail</h2>
            <span class="text-xs text-slate-500">${bundle.hashChain?.length || 0} events</span>
          </div>
          <div class="p-4 space-y-2">
            ${(bundle.hashChain || []).map(e => `
              <div class="flex items-center justify-between rounded-md bg-slate-50 px-3 py-2">
                <div class="text-sm text-slate-700">${PolicyTranslator.humanizeEventType(e.eventType)}</div>
                <div class="text-xs font-mono text-slate-500">${e.hash.slice(0, 16)}...</div>
              </div>
            `).join('')}
          </div>
        </div>

        <div class="mt-6 rounded-lg bg-white shadow-sm ring-1 ring-slate-200">
          <div class="p-4">
            <button class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-left text-xs font-semibold text-slate-700 hover:bg-slate-50" onclick="toggleRawJson()">
              ${showRawJson ? '‚ñº' : '‚ñ∂'} Reveal raw JSON
            </button>
            <div class="${showRawJson ? '' : 'hidden'} mt-3 rounded-md bg-slate-50 p-3 text-xs font-mono text-slate-700 overflow-auto max-h-96">${JSON.stringify(bundle, null, 2)}</div>
          </div>
        </div>
      `;
    }
    
    function renderHashChainProof(hashChain) {
      if (!hashChain || hashChain.length === 0) return '';
      
      return `
        <div class="mt-4 rounded-lg bg-indigo-50 ring-1 ring-indigo-200 p-4">
          <div class="text-sm font-semibold text-indigo-900">Hash Chain Proof</div>
          <div class="mt-3 space-y-2">
            ${hashChain.map((e, i) => `
              <div class="rounded-md bg-white px-3 py-2 ring-1 ring-indigo-100">
                <div class="text-xs text-indigo-700">${PolicyTranslator.humanizeEventType(e.eventType)}</div>
                <div class="mt-1 text-xs font-mono text-slate-600">Hash: ${e.hash.slice(0, 24)}...</div>
                ${e.prevHash ? `<div class="text-xs font-mono text-slate-500">Prev: ${e.prevHash.slice(0, 24)}... ${e.prevHash === hashChain[i-1]?.hash ? '‚úì' : ''}</div>` : '<div class="text-xs text-emerald-600">Genesis (Chain Start)</div>'}
              </div>
            `).join('')}
          </div>
          <p class="mt-3 text-xs text-slate-600">‚úì Each event links to the previous hash ‚Äî chain is intact</p>
        </div>
      `;
    }
    
    function renderBreachVisualization(breach, summary) {
      if (summary.outcome === 'AUTHORIZED' || summary.outcome === 'ACCEPTED') return '';
      
      const maxDisplay = breach.limit * 1.5;
      const limitPct = (breach.limit / maxDisplay * 100);
      const attemptPct = Math.min((breach.attempted / maxDisplay * 100), 100);
      
      return `
        <div class="p-4">
          <div class="flex items-center justify-between">
            <span class="text-sm font-semibold text-slate-900">${breach.label}</span>
            <span class="inline-flex items-center rounded-full bg-red-50 px-2.5 py-1 text-xs font-semibold text-red-700">+${breach.breachPercent}% over limit</span>
          </div>
          <div class="mt-3 h-3 rounded-full bg-red-100 relative overflow-hidden">
            <div class="absolute inset-y-0 left-0 bg-gradient-to-r from-emerald-400 via-amber-400 to-red-500" style="width: ${attemptPct}%"></div>
            <div class="absolute inset-y-0 w-1 bg-white" style="left: ${limitPct}%"></div>
          </div>
          <div class="mt-2 flex justify-between text-xs text-slate-500">
            <span>0</span>
            <span>Limit: ${breach.limit.toLocaleString()}</span>
            <span>Attempt: ${breach.attempted.toLocaleString()}</span>
          </div>
        </div>
      `;
    }
    
    // P1: Render Snapshot Economics section
    function renderSnapshotEconomics(summary, econ) {
      // Get snapshot economics from audit chain events if available
      const snapshotEconomics = summary.snapshotEconomics || null;
      const order = summary.order || {};
      
      // Calculate notional from order if snapshot not available
      const price = snapshotEconomics?.decision_time_price ?? order.price ?? null;
      const qty = snapshotEconomics?.qty ?? order.qty ?? 0;
      const notional = snapshotEconomics?.notional ?? (price && qty ? price * qty : null);
      const priceSource = snapshotEconomics?.price_source ?? (price ? 'FIRM' : 'UNAVAILABLE');
      
      // P1-R1: Price assertion trust boundary
      const priceAssertedBy = snapshotEconomics?.price_asserted_by ?? null;
      const priceAssertedAt = snapshotEconomics?.price_asserted_at ?? null;
      const priceSignature = snapshotEconomics?.price_signature ?? null;
      // P1-R3: Currency validation
      const currency = snapshotEconomics?.currency ?? 'USD';
      const currencySupported = snapshotEconomics?.currency_validation?.supported !== false;
      
      const isBlocked = summary.outcome === 'BLOCKED';
      const savedExposure = snapshotEconomics?.saved_exposure ?? (isBlocked ? notional : null);
      const projectedDelta = snapshotEconomics?.projected_exposure_delta ?? (!isBlocked ? notional : null);
      const exposurePre = snapshotEconomics?.exposure_pre;
      const exposurePost = snapshotEconomics?.exposure_post;
      
      // Format assertion timestamp
      const assertedAtFormatted = priceAssertedAt ? new Date(priceAssertedAt).toLocaleString() : null;
      
      // If no price available, show minimal card
      if (!price && !notional) {
        return `
        <div class="mt-6 rounded-lg bg-white shadow-sm ring-1 ring-slate-200">
          <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
            <h2 class="text-sm font-semibold text-slate-900">Snapshot Economics</h2>
            <span class="inline-flex items-center rounded-full bg-amber-50 px-2.5 py-1 text-xs font-semibold text-amber-700">Price Unavailable</span>
          </div>
          <div class="p-4 text-sm text-slate-500">
            Economics unavailable ‚Äî market order without reference price.
          </div>
        </div>
        `;
      }
      
      return `
        <div class="mt-6 rounded-lg bg-white shadow-sm ring-1 ring-slate-200">
          <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
            <h2 class="text-sm font-semibold text-slate-900">Snapshot Economics</h2>
            <div class="flex items-center gap-2">
              ${!currencySupported ? `<span class="inline-flex items-center rounded-full bg-amber-50 px-2.5 py-1 text-xs font-semibold text-amber-700">${currency} (excl)</span>` : ''}
              <span class="inline-flex items-center rounded-full ${priceSource === 'FIRM' ? 'bg-emerald-50 text-emerald-700' : 'bg-amber-50 text-amber-700'} px-2.5 py-1 text-xs font-semibold">${priceSource}</span>
            </div>
          </div>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 p-4">
            <div class="rounded-md bg-slate-50 p-3 ring-1 ring-slate-200">
              <div class="text-xs uppercase text-slate-500">Decision Price</div>
              <div class="mt-2 text-lg font-semibold font-mono text-slate-900">$${price?.toFixed(2) ?? 'N/A'}</div>
            </div>
            <div class="rounded-md bg-slate-50 p-3 ring-1 ring-slate-200">
              <div class="text-xs uppercase text-slate-500">Quantity</div>
              <div class="mt-2 text-lg font-semibold font-mono text-slate-900">${qty.toLocaleString()}</div>
            </div>
            <div class="rounded-md bg-slate-50 p-3 ring-1 ring-slate-200">
              <div class="text-xs uppercase text-slate-500">Notional</div>
              <div class="mt-2 text-lg font-semibold font-mono text-slate-900">$${notional?.toLocaleString() ?? 'N/A'}</div>
            </div>
            ${isBlocked ? `
            <div class="rounded-md bg-emerald-50 p-3 ring-1 ring-emerald-200">
              <div class="text-xs uppercase text-emerald-700">Saved Exposure</div>
              <div class="mt-2 text-lg font-semibold font-mono text-emerald-700">$${savedExposure?.toLocaleString() ?? 'N/A'}</div>
            </div>
            ` : `
            <div class="rounded-md bg-indigo-50 p-3 ring-1 ring-indigo-200">
              <div class="text-xs uppercase text-indigo-700">Projected Œî</div>
              <div class="mt-2 text-lg font-semibold font-mono text-indigo-700">+$${projectedDelta?.toLocaleString() ?? 'N/A'}</div>
            </div>
            `}
          </div>
          ${priceAssertedBy ? `
          <div class="border-t border-slate-200 px-4 py-3 bg-slate-50">
            <div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-xs text-slate-600">
              <span class="font-medium text-slate-700">Price Assertion:</span>
              <span>By: <span class="font-mono">${priceAssertedBy}</span></span>
              ${assertedAtFormatted ? `<span>At: <span class="font-mono">${assertedAtFormatted}</span></span>` : ''}
              ${priceSignature ? `<span class="text-slate-400" title="${priceSignature}">‚úì Signed</span>` : ''}
            </div>
          </div>
          ` : ''}
          ${exposurePre !== undefined && exposurePre !== null ? `
          <div class="border-t border-slate-200 px-4 py-3">
            <div class="flex items-center gap-4 text-sm">
              <span class="text-slate-500">Exposure Pre:</span>
              <span class="font-mono text-slate-700">$${exposurePre.toLocaleString()}</span>
              ${exposurePost !== undefined && exposurePost !== null ? `
              <span class="text-slate-400">‚Üí</span>
              <span class="text-slate-500">Post:</span>
              <span class="font-mono text-slate-700">$${exposurePost.toLocaleString()}</span>
              ` : ''}
            </div>
          </div>
          ` : ''}
        </div>
      `;
    }
    
    async function renderPlayground() {
      const app = document.getElementById('app');
      
      const sampleOrder = {
        clientOrderId: "test-001",
        symbol: "AAPL",
        side: "BUY",
        qty: 100,
        price: 150.00
      };
      
      app.innerHTML = `
        <div class="rounded-lg bg-white shadow-sm ring-1 ring-slate-200 p-4">
          <div class="flex items-center justify-between">
            <h2 class="text-sm font-semibold text-slate-900">Simulation Lab</h2>
            <span class="text-xs text-slate-500">No ledger write</span>
          </div>
          <p class="mt-2 text-xs text-slate-500">Enter an order JSON below to see how the guardrail engine would evaluate it. No data is persisted.</p>
          
          <textarea id="playground-input" class="mt-3 w-full min-h-[150px] rounded-md border border-slate-300 bg-slate-50 p-3 text-xs font-mono text-slate-900 focus:outline-none focus:ring-2 focus:ring-indigo-500">${JSON.stringify(sampleOrder, null, 2)}</textarea>
          
          <div class="mt-3 flex items-center gap-2">
            <button class="inline-flex items-center rounded-md bg-indigo-600 px-3 py-2 text-xs font-semibold text-white hover:bg-indigo-700" onclick="runPlayground()">Run Simulation</button>
            <button class="inline-flex items-center rounded-md border border-slate-300 bg-white px-3 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50" onclick="loadSampleBlocked()">Load Blocked Example</button>
          </div>
          
          <div id="playground-result" class="mt-4"></div>
        </div>
        
        <div class="mt-6 rounded-lg bg-white shadow-sm ring-1 ring-slate-200">
          <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
            <h2 class="text-sm font-semibold text-slate-900">Active Guardrail Set</h2>
            <span class="text-xs text-slate-500">policy.v0.2</span>
          </div>
          <div class="p-4">
            <ul class="divide-y divide-slate-200">
              <li class="py-2.5 flex items-center justify-between text-xs">
                <span class="font-mono">qty_limit</span>
                <span class="text-slate-500">Quantity &gt; 1,000</span>
                <span class="inline-flex items-center gap-2 rounded-full bg-red-50 px-2.5 py-1 font-semibold text-red-700"><span class="h-2 w-2 rounded-full bg-red-500"></span>Block</span>
              </li>
              <li class="py-2.5 flex items-center justify-between text-xs">
                <span class="font-mono">symbol_gme</span>
                <span class="text-slate-500">Symbol = GME AND Quantity &gt; 10</span>
                <span class="inline-flex items-center gap-2 rounded-full bg-red-50 px-2.5 py-1 font-semibold text-red-700"><span class="h-2 w-2 rounded-full bg-red-500"></span>Block</span>
              </li>
              <li class="py-2.5 flex items-center justify-between text-xs">
                <span class="font-mono">penny_stock</span>
                <span class="text-slate-500">Price &lt; $1.00 AND Quantity &gt; 100</span>
                <span class="inline-flex items-center gap-2 rounded-full bg-red-50 px-2.5 py-1 font-semibold text-red-700"><span class="h-2 w-2 rounded-full bg-red-500"></span>Block</span>
              </li>
              <li class="py-2.5 flex items-center justify-between text-xs">
                <span class="font-mono">allow_default</span>
                <span class="text-slate-500">No blocking rules match</span>
                <span class="inline-flex items-center gap-2 rounded-full bg-emerald-50 px-2.5 py-1 font-semibold text-emerald-700"><span class="h-2 w-2 rounded-full bg-emerald-500"></span>Allow</span>
              </li>
            </ul>
          </div>
        </div>
      `;
    }
    
    async function runPlayground() {
      const input = document.getElementById('playground-input').value;
      const resultDiv = document.getElementById('playground-result');
      
      try {
        const order = JSON.parse(input);
        resultDiv.innerHTML = '<div class="text-xs text-slate-500">Evaluating...</div>';
        
        const result = await testPolicy(order);
        
        const isAllowed = result.decision === 'ALLOW' || result.allow === true;
        const reasonCode = result.reasonCode || result.reason_code || 'UNKNOWN';
        const ruleId = result.ruleId || result.rule_id || '-';
        const policyVersion = result.policyVersion || 'policy.v0.2';
        
        // Use preview economics from response (already calculated server-side)
        const previewEcon = result.previewEconomics || {};
        const attemptNotional = previewEcon.attemptNotional || (order.qty || 0) * (order.price || 0);
        const savedExposure = previewEcon.savedExposure || 0;
        const simulationCost = previewEcon.simulationCost ?? 0;
        
        resultDiv.innerHTML = `
          <div class="rounded-lg border border-slate-200 bg-slate-50 p-4 relative">
            <div class="absolute -top-2 left-4 bg-slate-50 px-2 text-[10px] uppercase font-semibold text-amber-700">Simulation (No Ledger Write)</div>
            <div class="text-center text-lg font-semibold ${isAllowed ? 'text-emerald-700' : 'text-red-700'}">
              ${isAllowed ? '‚úì WOULD ALLOW' : '‚úó WOULD BLOCK'}
            </div>
            <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3 text-xs">
              <div>
                <div class="text-slate-500">Guardrail Reason</div>
                <div class="font-mono">${PolicyTranslator.humanizeReason(reasonCode)}</div>
              </div>
              <div>
                <div class="text-slate-500">Rule Triggered</div>
                <div class="font-mono">${ruleId}</div>
              </div>
              <div>
                <div class="text-slate-500">Guardrail Set</div>
                <div class="font-mono">${policyVersion}</div>
              </div>
              <div>
                <div class="text-slate-500">Attempt Notional</div>
                <div class="font-mono">$${attemptNotional.toLocaleString()}</div>
              </div>
              ${!isAllowed ? `
              <div>
                <div class="text-emerald-700">Saved Exposure</div>
                <div class="font-mono text-emerald-700">$${savedExposure.toLocaleString()}</div>
              </div>
              ` : ''}
              <div>
                <div class="text-slate-500">Simulation Cost</div>
                <div class="font-mono text-slate-600">$${simulationCost}</div>
              </div>
            </div>
            <p class="mt-3 text-xs text-slate-500">${PolicyTranslator.explanations[reasonCode] || 'Guardrail evaluation complete'}</p>
          </div>
        `;
      } catch (err) {
        resultDiv.innerHTML = `
          <div class="rounded-lg border border-red-200 bg-red-50 p-3 text-xs text-red-700">
            Error: ${err.message}
          </div>
        `;
      }
    }
    
    function loadSampleBlocked() {
      const blockedExample = {
        clientOrderId: "test-blocked",
        symbol: "GME",
        side: "BUY",
        qty: 500,
        price: 25.00
      };
      document.getElementById('playground-input').value = JSON.stringify(blockedExample, null, 2);
    }

    async function renderWebhooks() {
      const [webhooks, deliveries] = await Promise.all([
        fetchWebhooks(),
        fetchDeliveries()
      ]);
      
      const app = document.getElementById('app');

      app.innerHTML = `
        <div class="rounded-lg bg-white shadow-sm ring-1 ring-slate-200">
          <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
            <h2 class="text-sm font-semibold text-slate-900">Registered Integrations</h2>
            <span class="text-xs text-slate-500">${webhooks.length} webhook(s)</span>
          </div>
          ${webhooks.length === 0 ? `
            <div class="p-4 text-xs text-slate-500">No integrations registered yet.</div>
          ` : `
            <ul class="divide-y divide-slate-200">
              ${webhooks.map(w => `
                <li class="py-2.5 px-4 text-xs flex items-center justify-between">
                  <span class="font-mono">${w.url}</span>
                  <span class="text-slate-500">${w.events.join(', ')}</span>
                  <span class="text-slate-500 font-mono">${formatTime(w.createdAt)}</span>
                  <span class="inline-flex items-center gap-2 rounded-full ${w.active ? 'bg-emerald-50 text-emerald-700' : 'bg-red-50 text-red-700'} px-2.5 py-1 font-semibold">
                    <span class="h-2 w-2 rounded-full ${w.active ? 'bg-emerald-500' : 'bg-red-500'}"></span>${w.active ? 'Active' : 'Inactive'}
                  </span>
                </li>
              `).join('')}
            </ul>
          `}
        </div>
        
        <div class="mt-6 rounded-lg bg-white shadow-sm ring-1 ring-slate-200">
          <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
            <h2 class="text-sm font-semibold text-slate-900">Recent Deliveries</h2>
            <span class="text-xs text-slate-500">${deliveries.count || 0} deliveries</span>
          </div>
          ${!deliveries.deliveries || deliveries.deliveries.length === 0 ? `
            <div class="p-4 text-xs text-slate-500">No webhook deliveries yet.</div>
          ` : `
            <ul class="divide-y divide-slate-200">
              ${deliveries.deliveries.map(d => `
                <li class="py-2.5 px-4 text-xs flex items-center justify-between">
                  <span class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-2.5 py-1 font-semibold text-slate-700">
                    <span class="h-2 w-2 rounded-full bg-slate-400"></span>${d.eventType}
                  </span>
                  <button class="text-indigo-600 hover:text-indigo-700 font-mono" onclick="navigate('evaluations', {traceId: '${d.traceId}'})">${d.traceId?.slice(0, 8) || '-'}...</button>
                  <span class="inline-flex items-center gap-2 rounded-full ${d.success ? 'bg-emerald-50 text-emerald-700' : 'bg-red-50 text-red-700'} px-2.5 py-1 font-semibold">
                    <span class="h-2 w-2 rounded-full ${d.success ? 'bg-emerald-500' : 'bg-red-500'}"></span>${d.success ? `OK (${d.statusCode})` : 'Failed'}
                  </span>
                  <span class="text-slate-500 font-mono">${formatTime(d.createdAt)}</span>
                </li>
              `).join('')}
            </ul>
          `}
        </div>
      `;
    }

    // =========================================================================
    // Helpers
    // =========================================================================
    function formatTime(iso) {
      if (!iso) return '-';
      const d = new Date(iso);
      return d.toLocaleString();
    }
    
    function toggleHashChain() {
      showHashChainExpanded = !showHashChainExpanded;
      render();
    }
    
    function toggleRawJson() {
      showRawJson = !showRawJson;
      render();
    }

    // Init
    navigate('evaluations');
  </script>
</body>
</html>

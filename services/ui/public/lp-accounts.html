<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BrokerOps ‚Äî LP Accounts</title>
  <link rel="stylesheet" href="/assets/ui.css" />
  <script src="/assets/global-context.js"></script>
  <style>
    body.embed-mode .shell-frame { padding: 0; }
  </style>
</head>
<body>
  <div class="shell-frame">
    <header class="page-header">
      <div>
        <h1 class="page-title">LP Accounts</h1>
        <div class="page-subtitle">Margin health ‚Ä¢ rejection reasons ‚Ä¢ investigation-first</div>
      </div>
      <div class="page-actions">
        <button class="btn btn-ghost" id="lp-export-snapshot">Export Snapshot</button>
        <button class="btn btn-ghost" id="lp-view-history">Snapshot History</button>
        <button class="btn" id="lp-refresh">Refresh</button>
      </div>
    </header>

    <!-- Summary cards (required anchor: lp-summary) -->
    <section class="panel" id="lp-summary">
      <div class="kpi-row" id="lp-kpis">
        <div class="kpi">
          <div class="kpi-label">LPs</div>
          <div class="kpi-value" id="lp-kpi-count">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Reject rate (window)</div>
          <div class="kpi-value" id="lp-kpi-reject-rate">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Worst margin</div>
          <div class="kpi-value" id="lp-kpi-worst">‚Äî</div>
        </div>
        <div class="kpi">
          <div class="kpi-label">Orders (window)</div>
          <div class="kpi-value" id="lp-kpi-orders">‚Äî</div>
        </div>
      </div>
    </section>

    <!-- Filters (required anchor: lp-filters) -->
    <section class="panel" id="lp-filters">
      <div class="filter-row">
        <input class="input" id="lp-search" data-local-search placeholder="/ search LP name, id" />
        <select class="select" id="lp-health">
          <option value="">All health</option>
          <option value="HEALTHY">Healthy</option>
          <option value="WARN">Warn</option>
          <option value="CRITICAL">Critical</option>
        </select>
        <div class="segmented" role="tablist" aria-label="View">
          <button class="seg-btn active" id="lp-view-cards">Cards</button>
          <button class="seg-btn" id="lp-view-table">Table</button>
        </div>
      </div>
    </section>

    <!-- Loading state (required anchor: lp-loading) -->
    <section class="panel" id="lp-loading" style="display:flex; justify-content:center; align-items:center; padding:40px;">
      <div style="text-align:center;">
        <div class="spinner" style="margin:0 auto 16px;"></div>
        <div class="muted">Loading LP accounts‚Ä¶</div>
      </div>
    </section>

    <!-- Empty state (required anchor: lp-empty-state) -->
    <section class="panel" id="lp-empty-state" style="display:none; padding:40px; text-align:center;">
      <div style="max-width:400px; margin:0 auto;">
        <div style="font-size:48px; margin-bottom:16px; opacity:0.3;">üìä</div>
        <h3 style="color:var(--slate-200); margin-bottom:8px;">No LP accounts in window</h3>
        <p class="muted" style="margin-bottom:16px;">No LP accounts match the current filters or time window.</p>
        <div style="display:flex; gap:8px; justify-content:center;">
          <button class="btn" id="lp-empty-refresh">Refresh</button>
          <button class="btn btn-ghost" id="lp-empty-clear-filters">Clear Filters</button>
        </div>
      </div>
    </section>

    <!-- Error state (required anchor: lp-error-banner) -->
    <section class="panel" id="lp-error-banner" style="display:none; padding:24px; background:rgba(244,63,94,0.1); border-color:rgba(244,63,94,0.3);">
      <div style="display:flex; align-items:center; gap:12px;">
        <span style="font-size:24px;">‚ö†Ô∏è</span>
        <div style="flex:1;">
          <div style="color:var(--rose-400); font-weight:600;">Failed to load LP accounts</div>
          <div class="muted" id="lp-error-message">API unavailable. Check your connection and try again.</div>
        </div>
        <button class="btn" id="lp-error-retry">Retry</button>
      </div>
    </section>

    <!-- Cards grid (information dense, anomaly-first) -->
    <section class="panel" id="lp-cards" style="display:none;">
      <div class="card-grid" id="lp-grid"></div>
    </section>

    <!-- Table (required anchor: lp-table) -->
    <section class="panel" id="lp-table" style="display:none;">
      <div class="table-wrap">
        <table class="table table-dense">
          <thead>
            <tr>
              <th>LP</th>
              <th>Margin</th>
              <th>Equity</th>
              <th>Free</th>
              <th>Rejects</th>
              <th>Reject rate</th>
              <th>Server</th>
            </tr>
          </thead>
          <tbody id="lp-tbody"><tr><td colspan="7" class="muted">Loading‚Ä¶</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- Slide-in detail panel (required anchor: lp-detail) -->
    <aside class="slide-panel" id="lp-detail" aria-hidden="true">
      <div class="slide-header">
        <div>
          <div class="kicker">LP</div>
          <div class="slide-title" id="lp-detail-title">‚Äî</div>
        </div>
        <button class="btn btn-ghost" id="lp-detail-close" title="Esc">‚úï</button>
      </div>
      <div class="slide-body" id="lp-detail-body">
        <div class="muted">Select an LP</div>
      </div>
      <div class="slide-footer">
        <button class="btn btn-ghost" id="lp-detail-view-orders">View Orders</button>
      </div>
    </aside>

  </div>

<script>
(function(){
  const params = new URLSearchParams(location.search);
  if (params.get('embed') === '1') document.body.classList.add('embed-mode');

  let ctx = { server:'all', window:'24h', q:'' };
  let lps = [];
  let selected = null;

  const $grid = document.getElementById('lp-grid');
  const $tbody = document.getElementById('lp-tbody');
  const $empty = document.getElementById('lp-empty');
  const $cards = document.getElementById('lp-cards');
  const $tablePanel = document.getElementById('lp-table');

  function pct(n){
    if (n === null || n === undefined || n === '') return '‚Äî';
    const v = Number(n);
    if (!Number.isFinite(v)) return String(n);
    return `${v.toFixed(0)}%`;
  }

  function money(n){
    if (n === null || n === undefined || n === '') return '‚Äî';
    const v = Number(n);
    if (!Number.isFinite(v)) return String(n);
    return v.toLocaleString(undefined,{minimumFractionDigits:0, maximumFractionDigits:0});
  }

  function healthFromMargin(m){
    const v = Number(m);
    if (!Number.isFinite(v)) return 'UNKNOWN';
    if (v < 35) return 'CRITICAL';
    if (v < 55) return 'WARN';
    return 'HEALTHY';
  }

  function bullet(m){
    const v = Math.max(0, Math.min(100, Number(m) || 0));
    const health = healthFromMargin(v);
    const cls = health === 'CRITICAL' ? 'bg-critical' : (health === 'WARN' ? 'bg-warn' : 'bg-ok');
    return `
      <div class="bullet">
        <div class="bullet-track">
          <div class="bullet-fill ${cls}" style="width:${v}%;"></div>
        </div>
        <div class="bullet-labels">
          <span>0%</span><span class="warn">50%</span><span class="crit">100%</span>
        </div>
      </div>
    `;
  }

  function renderKPIs(){
    const count = lps.length;
    document.getElementById('lp-kpi-count').textContent = count;

    // best-effort metrics
    let worst = null;
    let orders = 0;
    let rejects = 0;
    for (const lp of lps){
      const m = Number(lp.margin_level ?? lp.margin ?? lp.marginLevel);
      if (Number.isFinite(m)) worst = worst === null ? m : Math.min(worst, m);
      orders += Number(lp.orders_count ?? lp.orders ?? 0) || 0;
      rejects += Number(lp.reject_count ?? lp.rejects ?? 0) || 0;
    }
    document.getElementById('lp-kpi-worst').textContent = worst === null ? '‚Äî' : pct(worst);
    document.getElementById('lp-kpi-orders').textContent = orders ? orders.toLocaleString() : '‚Äî';
    document.getElementById('lp-kpi-reject-rate').textContent = orders ? `${((rejects/orders)*100).toFixed(2)}%` : '‚Äî';
  }

  function cardHtml(lp){
    const id = lp.id ?? lp.lp_id ?? lp.account_id ?? '‚Äî';
    const name = lp.name ?? lp.label ?? lp.display_name ?? id;
    const server = lp.server ?? lp.server_id ?? lp.serverId ?? '‚Äî';
    const margin = lp.margin_level ?? lp.margin ?? lp.marginLevel;
    const equity = lp.equity ?? lp.Equity;
    const free = lp.free_margin ?? lp.free ?? lp.Free;
    const rejects = lp.reject_count ?? lp.rejects ?? 0;
    const orders = lp.orders_count ?? lp.orders ?? 0;
    const rejectRate = (Number(orders) > 0) ? (Number(rejects)/Number(orders))*100 : null;
    const health = healthFromMargin(margin);

    return `
      <article class="lp-card" data-id="${String(id).replace(/"/g,'')}">
        <div class="lp-card-top">
          <div>
            <div class="lp-title">${escapeHtml(String(name))}</div>
            <div class="lp-sub">
              <span class="mono copy" data-copy="${escapeHtml(String(id))}">${escapeHtml(String(id))}</span>
              <span class="badge badge-neutral">${escapeHtml(String(server))}</span>
            </div>
          </div>
          <div class="badge ${healthBadgeCls(health)}">${health}</div>
        </div>

        <div class="lp-section">
          <div class="lp-section-title">Margin level</div>
          ${bullet(margin)}
          <div class="lp-metrics">
            <div><span class="muted">Equity</span><span class="mono">${money(equity)}</span></div>
            <div><span class="muted">Free</span><span class="mono">${money(free)}</span></div>
            <div><span class="muted">Reject rate</span><span class="mono">${rejectRate === null ? '‚Äî' : rejectRate.toFixed(2)+'%'}</span></div>
          </div>
        </div>

        <div class="lp-actions">
          <button class="btn btn-ghost" data-action="details">Details</button>
          <button class="btn btn-ghost" data-action="orders">View Orders</button>
        </div>
      </article>
    `;
  }

  function escapeHtml(s){
    return s
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'",'&#039;');
  }

  function healthBadgeCls(h){
    if (h === 'CRITICAL') return 'badge-critical';
    if (h === 'WARN') return 'badge-warn';
    if (h === 'HEALTHY') return 'badge-ok';
    return 'badge-neutral';
  }

  function renderCards(filtered){
    $grid.innerHTML = '';
    if (!filtered.length){
      $empty.style.display = 'block';
      return;
    }
    $empty.style.display = 'none';
    for (const lp of filtered){
      const wrap = document.createElement('div');
      wrap.innerHTML = cardHtml(lp).trim();
      $grid.appendChild(wrap.firstElementChild);
    }
    BO_CTX.attachCopyHandlers(document.body);
  }

  function renderTable(filtered){
    $tbody.innerHTML = '';
    if (!filtered.length){
      $tbody.innerHTML = '<tr><td colspan="7" class="muted">No LP accounts</td></tr>';
      return;
    }
    for (const lp of filtered){
      const id = lp.id ?? lp.lp_id ?? lp.account_id ?? '‚Äî';
      const name = lp.name ?? lp.label ?? lp.display_name ?? id;
      const server = lp.server ?? lp.server_id ?? lp.serverId ?? '‚Äî';
      const margin = lp.margin_level ?? lp.margin ?? lp.marginLevel;
      const equity = lp.equity ?? lp.Equity;
      const free = lp.free_margin ?? lp.free ?? lp.Free;
      const rejects = Number(lp.reject_count ?? lp.rejects ?? 0) || 0;
      const orders = Number(lp.orders_count ?? lp.orders ?? 0) || 0;
      const rejectRate = orders ? (rejects/orders)*100 : null;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <div class="row-title">${escapeHtml(String(name))}</div>
          <div class="row-sub mono copy" data-copy="${escapeHtml(String(id))}">${escapeHtml(String(id))}</div>
        </td>
        <td>
          <div class="mono">${pct(margin)}</div>
          ${bullet(margin)}
        </td>
        <td class="mono">${money(equity)}</td>
        <td class="mono">${money(free)}</td>
        <td class="mono">${rejects}</td>
        <td class="mono">${rejectRate === null ? '‚Äî' : rejectRate.toFixed(2)+'%'}</td>
        <td><span class="badge badge-neutral">${escapeHtml(String(server))}</span></td>
      `;
      tr.addEventListener('click', () => openDetail(lp));
      $tbody.appendChild(tr);
    }
    BO_CTX.attachCopyHandlers(document.body);
  }

  async function fetchJson(url){
    const res = await fetch(BO_CTX.withParams(url), { headers: { 'Accept': 'application/json' } });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    return await res.json();
  }

  // State machine: loading | empty | error | ready
  let currentState = 'loading';
  const $loading = document.getElementById('lp-loading');
  const $emptyState = document.getElementById('lp-empty-state');
  const $errorBanner = document.getElementById('lp-error-banner');

  function setState(state, errorMsg = null) {
    currentState = state;
    // Hide all state panels first
    $loading.style.display = 'none';
    $emptyState.style.display = 'none';
    $errorBanner.style.display = 'none';
    $cards.style.display = 'none';
    $tablePanel.style.display = 'none';

    switch (state) {
      case 'loading':
        $loading.style.display = 'flex';
        break;
      case 'empty':
        $emptyState.style.display = 'block';
        break;
      case 'error':
        $errorBanner.style.display = 'block';
        if (errorMsg) document.getElementById('lp-error-message').textContent = errorMsg;
        break;
      case 'ready':
        // Show cards or table based on current view toggle
        if (document.getElementById('lp-view-table').classList.contains('active')) {
          $tablePanel.style.display = 'block';
        } else {
          $cards.style.display = 'block';
        }
        break;
    }
  }

  async function refresh(){
    setState('loading');
    try{
      const data = await fetchJson('/api/lp-accounts');
      lps = Array.isArray(data?.data) ? data.data : [];
      renderKPIs();
      applyFiltersAndRender();
    }catch(e){
      lps = [];
      renderKPIs();
      setState('error', e.message || 'API unavailable. Check your connection and try again.');
    }
  }

  function applyFiltersAndRender(){
    const q = (document.getElementById('lp-search').value || '').trim().toLowerCase();
    const health = document.getElementById('lp-health').value;

    const filtered = lps.filter(lp => {
      const id = String(lp.id ?? lp.lp_id ?? lp.account_id ?? '').toLowerCase();
      const name = String(lp.name ?? lp.label ?? lp.display_name ?? '').toLowerCase();
      const m = Number(lp.margin_level ?? lp.margin ?? lp.marginLevel);
      const h = healthFromMargin(m);
      const okQ = !q || id.includes(q) || name.includes(q);
      const okH = !health || h === health;
      return okQ && okH;
    });

    // Use state machine for empty vs ready
    if (filtered.length === 0) {
      setState('empty');
    } else {
      setState('ready');
      if (document.getElementById('lp-view-table').classList.contains('active')) {
        renderTable(filtered);
      } else {
        renderCards(filtered);
      }
    }
  }

  function showPanel(id){
    const el = document.getElementById(id);
    el.setAttribute('aria-hidden','false');
    el.classList.add('open');
  }

  function hidePanel(id){
    const el = document.getElementById(id);
    el.setAttribute('aria-hidden','true');
    el.classList.remove('open');
  }

  async function openDetail(lp){
    selected = lp;
    const id = lp.id ?? lp.lp_id ?? lp.account_id;
    document.getElementById('lp-detail-title').textContent = (lp.name ?? lp.label ?? lp.display_name ?? id ?? 'LP');

    showPanel('lp-detail');
    document.getElementById('lp-detail-body').innerHTML = '<div class="muted">Loading‚Ä¶</div>';

    try{
      const single = id ? await fetchJson(`/api/lp-accounts/${encodeURIComponent(id)}`) : null;
      const hist = id ? await fetchJson(`/api/lp-accounts/${encodeURIComponent(id)}/history?limit=20`) : null;

      const s = single?.data ?? lp;
      const h = Array.isArray(hist?.data) ? hist.data : [];

      const margin = s.margin_level ?? s.margin ?? s.marginLevel;
      const equity = s.equity ?? s.Equity;
      const free = s.free_margin ?? s.free ?? s.Free;
      const server = s.server ?? s.server_id ?? s.serverId ?? '‚Äî';

      const last = h[0]?.timestamp ?? h[0]?.ts ?? h[0]?.created_at;

      document.getElementById('lp-detail-body').innerHTML = `
        <div class="detail-grid">
          <div class="detail-item"><div class="muted">Server</div><div><span class="badge badge-neutral">${escapeHtml(String(server))}</span></div></div>
          <div class="detail-item"><div class="muted">Margin</div><div class="mono">${pct(margin)}</div>${bullet(margin)}</div>
          <div class="detail-item"><div class="muted">Equity</div><div class="mono">${money(equity)}</div></div>
          <div class="detail-item"><div class="muted">Free</div><div class="mono">${money(free)}</div></div>
          <div class="detail-item"><div class="muted">Last snapshot</div><div class="mono" title="${escapeHtml(String(last||''))}">${last ? BO_CTX.formatRelativeTime(last) : '‚Äî'}</div></div>
        </div>
        <hr class="hr" />
        <div class="muted">Snapshots (latest 20)</div>
        <div class="snapshots">
          ${h.length ? h.map(row => {
            const t = row.timestamp ?? row.ts ?? row.created_at ?? '';
            const m = row.margin_level ?? row.margin ?? '';
            return `<div class="snap-row"><span class="mono" title="${escapeHtml(String(t))}">${BO_CTX.formatRelativeTime(t)}</span><span class="mono">${pct(m)}</span></div>`;
          }).join('') : '<div class="muted">No history</div>'}
        </div>
      `;
    }catch(e){
      document.getElementById('lp-detail-body').innerHTML = '<div class="muted">Failed to load LP details</div>';
    }
  }

  function initUI(){
    document.getElementById('lp-refresh').addEventListener('click', refresh);
    document.getElementById('lp-search').addEventListener('input', applyFiltersAndRender);
    document.getElementById('lp-health').addEventListener('change', applyFiltersAndRender);

    // Empty state actions
    document.getElementById('lp-empty-refresh').addEventListener('click', refresh);
    document.getElementById('lp-empty-clear-filters').addEventListener('click', () => {
      document.getElementById('lp-search').value = '';
      document.getElementById('lp-health').value = '';
      applyFiltersAndRender();
    });

    // Error state retry
    document.getElementById('lp-error-retry').addEventListener('click', refresh);

    document.getElementById('lp-view-cards').addEventListener('click', () => {
      document.getElementById('lp-view-cards').classList.add('active');
      document.getElementById('lp-view-table').classList.remove('active');
      if (currentState === 'ready') {
        $tablePanel.style.display = 'none';
        $cards.style.display = 'block';
      }
      applyFiltersAndRender();
    });
    document.getElementById('lp-view-table').addEventListener('click', () => {
      document.getElementById('lp-view-table').classList.add('active');
      document.getElementById('lp-view-cards').classList.remove('active');
      if (currentState === 'ready') {
        $cards.style.display = 'none';
        $tablePanel.style.display = 'block';
      }
      applyFiltersAndRender();
    });

    document.getElementById('lp-detail-close').addEventListener('click', () => hidePanel('lp-detail'));

    $grid.addEventListener('click', (e) => {
      const card = e.target.closest('.lp-card');
      if (!card) return;
      const id = card.getAttribute('data-id');
      const lp = lps.find(x => String(x.id ?? x.lp_id ?? x.account_id ?? '') === String(id));
      if (!lp) return;

      const action = e.target.getAttribute('data-action');
      if (action === 'orders') {
        BO_CTX.update({ q: String(id) });
        BO_CTX.navigate('orders');
        return;
      }
      openDetail(lp);
    });

    document.getElementById('lp-detail-view-orders').addEventListener('click', () => {
      const id = selected?.id ?? selected?.lp_id ?? selected?.account_id;
      BO_CTX.update({ q: String(id || '') });
      BO_CTX.navigate('orders');
    });

    // Export snapshot: download JSON list
    document.getElementById('lp-export-snapshot').addEventListener('click', async () => {
      const blob = new Blob([JSON.stringify({ exported_at: new Date().toISOString(), data: lps }, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `lp-snapshot-${Date.now()}.json`;
      a.click();
    });

    // History button: open first LP detail if any
    document.getElementById('lp-view-history').addEventListener('click', () => {
      if (lps.length) openDetail(lps[0]);
      else showPanel('lp-detail');
    });
  }

  // Context handshake + keyboard
  BO_CTX.initEmbedPage({
    onContext: (next) => { ctx = next; refresh(); },
    onEsc: () => { hidePanel('lp-detail'); }
  });

  initUI();
  refresh();
})();
</script>

</body>
</html>
